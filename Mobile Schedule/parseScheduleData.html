<!DOCTYPE html>
<html>
<head>
    <title>Schedule Parser</title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
</head>
<body>
<p>
<textarea rows="30" cols="180" id="input" ></textarea><br />
<input type="button" value="convert" id="convert" />
</p>
<script type="text/javascript" src="template.js"></script>
<script type="text/javascript">
    $("#convert").click(function(){
        var info = $("#input").val();
        var parsed = parseData(info);
        $("p").empty();
        showArray(parsed);
        var fileText = templateInfoPart1 + JSON.stringify(parsed) + templateInfoPart2;
        download("schedule.html", fileText);
    })
    
    function parseData(text) {
        var info = [];
        var beginning = "University of Waterloo";
        var end = "Printer Friendly Page";
        var classTypes = {
            "SEM": true,
            "TUT": true,
            "LAB": true,
            "LEC": true,
            "TST": true
        };
        var content = text.substring(text.indexOf(beginning) + beginning.length,text.indexOf(end));
        var lines = content.split("\n");
        var courseInfo = [];
        var courseName = [];
        var currentInfo = [];
        var type = "";
        var index = 0;
        for (var i = 0 ; i < lines.length ; i++) {
            line = lines[i];
            // looking for the line below the course code
            if (/Status/.test(line)){
                var course = lines[i-1]
                var courseParts = course.split(" - ");
                var courseCode = courseParts[0];
                var courseDescription = " - " + courseParts[1];

                if (currentInfo.length) {
                    courseInfo.push([type,currentInfo]);
                    currentInfo = [];
                }
                if (courseInfo.length) {
                    info.push([courseName,courseInfo]);
                }

                courseName = [courseCode,courseDescription];
                courseInfo = [];
                currentInfo = [];
                type = "";
                index = 0;
            } else if (classTypes[line]) {
                if (currentInfo.length) {
                    courseInfo.push([type,currentInfo]);
                    currentInfo = [];
                }
                type = line;
            } else if (/^[MTWTFh]{1,6} \d{1,2}:.+$/.test(lines[i])) {
                currentInfo.push([getClassLength(lines[i]),lines[i+1],parseDate(lines[i+3])])
                i += 4;
            }
        }
        return info;
    }

    function parseDate(date) {
        var returnValues = [];
        var dates = date.split(" - ");
        for (var i = 0 ; i < dates.length ; i++) {
            var dateparts = dates[i].split("/");
            //MM/DD/YYYY
            if (i==1) {
                returnValues.push(+new Date(dateparts[2],dateparts[0]-1,dateparts[1],23,59,59,999));
            } else {
                returnValues.push(+new Date(dateparts[2],dateparts[0]-1,dateparts[1]));
            }
        }
        return returnValues;
    }

    function getClassLength(range) {
        words = range.split(" ");
        startValue = parseTime(words[1]);
        endValue = parseTime(words[3]);
        return [words[0],startValue,endValue];
    }

    function parseTime(time){
        timeParts = time.split(":");
        timeHour = timeParts[0];
        timeValue = timeHour * 100;
        if (timeParts[1].indexOf("PM")>-1&&timeParts[0]!="12") {
            timeValue+=1200;
        }
        timeParts[1]=timeParts[1].slice(0,-2); //remove pm/am
        timeValue+=((timeParts[1])/(0.6));
        return timeValue;
    }

    //likely don't need, use JSON.stringify
    function showArray(data){
        if (Array.isArray(data)) {
            $("p").append("[");
            for(var i = 0 ; i<data.length ; i++) {
                showArray(data[i]);
                if (i!=data.length-1) {
                    $("p").append(",");
                }
            }
            $("p").append("]");
        } else if (typeof data.getMonth === "function") {
            $("p").append("new Date(\""+data+"\")");
        } else if (typeof data === "string") {
            $("p").append("\""+data+"\"");
        } else {
            $("p").append(data);
        }
    }


    function download(filename, text) {
        var pom = document.createElement("a");
        pom.setAttribute("href", "data:text/plain;charset=utf-8," + encodeURIComponent(text));
        pom.setAttribute("download", filename);

        if (document.createEvent) {
            var event = document.createEvent("MouseEvents");
            event.initEvent("click", true, true);
            pom.dispatchEvent(event);
        }
        else {
            pom.click();
        }
    }
</script>
</body>
</html>