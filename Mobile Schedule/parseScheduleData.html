<!DOCTYPE html>
<html>
<head>
    <title>Schedule Parser</title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
</head>
<body>
<p>
<textarea rows="30" cols="180" id="input" ></textarea><br />
<input type="button" value="convert" id="convert" />
</p>
<script type="text/javascript" src="template.js"></script>
<script type="text/javascript">
    $("#convert").click(function(){
        var info = $('#input').val();
        var parsed = parseData(info);
        $('p').empty();
        showArray(parsed);
        var fileText = templateInfoPart1 + JSON.stringify(parsed) + templateInfoPart2;
        download('schedule.html', fileText);
    })
    
    function parseData(text) {
        var info = [];
        var beginning = "University of Waterloo";
        var end = "Printer Friendly Page";
        var classTypes = ["SEM","TUT","LAB","LEC","TST"];
        var content = text.substring(text.indexOf(beginning) + beginning.length,text.indexOf(end));
        var courses = content.split("Exam Information");
        //last one is empty
        for (var i = 0 ; i < courses.length - 1 ; i++) {
            var courseInfo = [];
            var lines = courses[i].split("\n");
            var courseName = [];
            var currentInfo = [];
            var type = "";
            var index = 0;
            for (var j = 0 ; j < lines.length ; j++){
                var line = lines[j];
                if (/^[A-Z].+$/.test(line)){
                    var courseParts = line.split(" ");
                    var courseCode = courseParts[0] + " " + courseParts[1];
                    var courseDescription = line.substring(courseCode.length);
                    courseName = [courseCode,courseDescription];
                    break;
                }
            }
            for (var j = 0 ; j < lines.length ; j++) {
                for(var k = 0 ; k < classTypes.length ; k++) {
                    if (lines[j] == classTypes[k]){
                        if(currentInfo.length) {
                            courseInfo.push([type,currentInfo]);
                            currentInfo = [];
                        }
                        type = classTypes[k];
                        break;
                    }
                }
                if (/^[MTWTFh]{1,6} \d{1,2}:.+$/.test(lines[j])) {
                    currentInfo.push([getClassLength(lines[j]),lines[j+1],parseDate(lines[j+3])])
                    j+=4;
                }
            }
            if(currentInfo.length) {
                courseInfo.push([type,currentInfo]);
                currentInfo = [];
            }
            info.push([courseName,courseInfo]);
        }
        return info;
    }

    function parseDate(date) {
        var returnValues = [];
        var dates = date.split(" - ");
        for (var i = 0 ; i < dates.length ; i++) {
            var dateparts = dates[i].split("/");
            //MM/DD/YYYY
            if (i==1) {
                returnValues.push(+new Date(dateparts[2],dateparts[0]-1,dateparts[1],23,59,59,999));
            } else {
                returnValues.push(+new Date(dateparts[2],dateparts[0]-1,dateparts[1]));
            }
        }
        return returnValues;
    }

    function getClassLength(range) {
        words = range.split(" ");
        startValue = parseTime(words[1]);
        endValue = parseTime(words[3]);
        return [words[0],startValue,endValue];
    }

    function parseTime(time){
        timeParts = time.split(":");
        timeHour = timeParts[0];
        timeValue = timeHour * 100;
        if (timeParts[1].indexOf("PM")>-1&&timeParts[0]!="12") {
            timeValue+=1200;
        }
        timeParts[1]=timeParts[1].slice(0,-2); //remove pm/am
        timeValue+=((timeParts[1])/(0.6));
        return timeValue;
    }

    function showArray(data){
        if (Array.isArray(data)) {
            $('p').append('[');
            for(var i = 0 ; i<data.length ; i++) {
                showArray(data[i]);
                if (i!=data.length-1) {
                    $('p').append(',');
                }
            }
            $('p').append(']');
        } else if (typeof data.getMonth === 'function') {
            $('p').append('new Date("'+data+'")');
        } else if (typeof data === 'string') {
            $('p').append('"'+data+'"');
        } else {
            $('p').append(data);
        }
    }


    function download(filename, text) {
        var pom = document.createElement('a');
        pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        pom.setAttribute('download', filename);

        if (document.createEvent) {
            var event = document.createEvent('MouseEvents');
            event.initEvent('click', true, true);
            pom.dispatchEvent(event);
        }
        else {
            pom.click();
        }
    }
    //download('test.txt', 'Hello world!');

/*    function readTextFile(file) {
        var rawFile = new XMLHttpRequest();
        rawFile.open("GET", file, false);
        rawFile.onreadystatechange = function () {
            if(rawFile.readyState === 4) {
                if(rawFile.status === 200 || rawFile.status == 0) {
                    var allText = rawFile.responseText;
                    console.log(allText);
                    alert(allText);
                }
            }
        }
        rawFile.send(null);
    }

    //readTextFile("schedule.html")

    // Check for the various File API support.
if (window.File && window.FileReader && window.FileList && window.Blob) {
  // Great success! All the File APIs are supported.
} else {
  alert('The File APIs are not fully supported in this browser.');
}
function previewFile(file) {

  var reader  = new FileReader();

  reader.onloadend = function () {
    console.log(reader.result);
  }
  reader.readAsDataURL(file);
}
//previewFile(new FileReader("schedule.html"));
$.get("schedule.html",function(data){
    console.log(data);
});*/
</script>
</body>
</html>