chrome.runtime.getBackgroundPage(function(e){function a(){clearInterval(ae),clearInterval(ie),O=W.timeLeft,U=W.startTime,z=W.wastingTime,J=W.url,K=W.title,Q=new Date-U,$("#info").html(l(J,Q,K)),j=Z,ee=-1,q=0,$("#timeLine").empty(),i(-1,!1,Q,z),i(-2,!1),r(-1),c()}function i(e,a,i,r){var o=0;if(o=e===-2?j:i/Y*Z+q,q=o%1,o=Math.floor(o),o<1&&e!==-1)return q+=o,!0;var s=!0;o>=j?(o=j,j=0,s=!1):j-=o;var c="timeLine";e!==-2&&(c+=" wasting"+r,o>=3&&(c+=" timeLineBlock"));var l=$("<div style='width:"+o+"px;' class='"+c+"' id='"+t(e)+"'></div>");return a?$("#timeLine").append(l):$("#timeLine").prepend(l),e!==-2&&n(l,e),s}function t(e){return e===-2?"timeLineP":"timeLine"+(e-_)}function n(e,a){e.click(function(){ee=a+_,r(ee)}),e.hover(function(){r(a+_)},function(){r(ee)})}function r(e){clearTimeout(ie);var a="";if(e===-1){Q=new Date-U;var i=1-Q%1;ie=setTimeout(function(){r(e)},i),a=l(J,Q,K)}else a=l(X[e][2],X[e][0],X[e][3]);$("#info").html(a)}function o(e){z&&(e-=new Date-U),e<0&&(e=0),s(e)}function s(e){if($("#timeLeft").html(f(e)),z&&e>0){var a=(e-1)%1e3+1;R=setTimeout(function(){s(e-a)},a)}}function c(){var e=Y/Z;ae=setInterval(function(){var e=$("#timeLine div:last-child");e.width(e.width()+1),!e.hasClass("timeLineBlock")&&e.width()>=3&&e.addClass("timeLineBlock");for(var a=$("#timeLine div:first-child");a.width()<=0;)a.remove(),a=$("#timeLine div:first-child");a.width(a.width()-1),a.hasClass("timeLineBlock")&&a.width()<3&&a.removeClass("timeLineBlock")},e)}function l(e,a,i){return d(i," ",50)+"<br />"+d(e,"/",50)+"<br />Time spent:"+f(a)}function d(e,a,i){if(e.length>i){var t=0;do t=e.lastIndexOf(a),e=e.substring(0,t);while(t>i);e+=a+"..."}return e}function f(e){var a=Math.ceil(e/1e3);return Math.floor(a/60)+":"+("0"+Math.floor(a%60)).slice(-2)}function v(){if(ne){var e=$("<div id='logHolder' class='block'>!</div>");$("body").prepend(e),e.width(e.height()),e.one("click",m)}}function m(){for(var e=$("<div id='logs'></div>"),a=0;a<te.length;a++)if(!te[a][1]){var i=$("<div class='log block'>"+te[a][0]+"</div>");h(i,a),e.append(i)}var t=$("#logHolder");t.html(e),t.outerWidth($("body").width()-20),t.one("click",function(){this.remove(),v()})}function h(e,a){e.click(function(e){e.stopPropagation(),this.remove(),A("removeLog",a),ne--,ne||$("#logHolder").remove()})}function u(){var e=+$("#setTimer").val();I(e)}function p(e){var a=new Date;a-oe<1e3?(se+=e.toFixed(0),se.length>3&&(se=se.substring(1)),$("#setTimer").val(se)):(se=e,$("#setTimer").val(se)),oe=new Date}function k(e,a){$("#phraseHolder").remove();for(var i="<div id='phraseFront'>",t="<div id='phraseBack'>",n=0;n<e.length;n++)i+="<div id='phrase"+n+"' class='phrasePart'>"+e[n]+"</div>",t+="<div class='phrasePart'>"+e[n]+"</div>";i+="</div>",t+="</div>";var r="<div id='phraseHolder'><div id='phrase'>"+i+t+"</div></div>";$("body").prepend(r);var o=100,s=40,c=$("body").width()-s;c<$("#phraseFront").width()&&(o=Math.floor(o/($("#phraseFront").width()/c)),$(".phrasePart").css("font-size",o));var l=($("body").innerWidth()-$("#phraseFront").outerWidth())/2,d=($("body").innerHeight()-$("#phraseFront").outerHeight())/2;$("#phraseHolder").css("left",l),$("#phraseHolder").css("top",d),a&&$("#phrase0").addClass("filled"),w(1200)}function g(e,a){a?($("#phrase"+e).addClass("filled").removeClass("failed"),w(1200)):($("#phrase"+e).addClass("failed"),w(500))}function w(e){var a=.8,i=e?e/a/100:15;$("#phrase").css("opacity",a),clearInterval(re),fe||(re=setInterval(function(){a-=.01,$("#phrase").css("opacity",a),a<=0&&b()},i))}function b(){le=0,de=0,fe=!1}function C(){A("resetTime")}function T(){for(var e="",a="ABCDEFGHIJKLMNOPQRSTUVWXYZ",i=0;i<18;i++)e+=a.charAt(Math.floor(Math.random()*a.length));le=[e,function(){A("VIP")}],fe=!0,k(e,!1)}function L(){A("change",ee)}function y(){A("temp")}function A(e,a){chrome.runtime.sendMessage({from:"browserAction",action:e,input:a})}function I(e){A("setAlarm",e)}function H(e){A("removeAlarm",e)}function M(){A("stopAllAlarms")}function P(){A("snooze")}function D(e,a,i){var t=e.toLocaleTimeString();$("#alarmText"+(a+1)).html("Alarm at "+t),$("#alarm"+(a+1)).removeClass("notSet"),$("#alarm"+(a+1)).css({color:E[i],"border-color":E[i]}),$("#alarm"+(a+1)).bind("click",function(){H(a)})}function B(e,a){$("#alarmText"+(e+1)).html("Not Set"),$("#alarm"+(e+1)).addClass("notSet"),$("#alarm"+(e+1)).unbind("click"),$("#alarm"+(e+1)).css({color:N,"border-color":N}),$("#alarmText"+(e+1)).css("visibility","visible"),clearInterval(S[e])}function F(e){var a="hidden";S[e]=setInterval(function(){a="hidden"===a?"visible":"hidden",$("#alarmText"+(e+1)).css("visibility",a)},300)}function x(e){var a=parseInt($("#setTimer").val());(e>0||a>0)&&$("#setTimer").val(a+e)}for(var S=[0,0,0,0,0],W=e,E=e.typeColors,N=e.defaultColor,V=W.alarms,G=0;G<V.length;G++)1==V[G][0]?D(V[G][1],G,V[G][3]):2==V[G][0]&&(D(V[G][1],G,V[G][3]),F(G));var O=W.timeLeft,U=W.startTime,z=W.wastingTime,J=W.url,K=W.title,Q=new Date-U,R=-1;o(O),$("#info").html(l(J,Q,K));var X=W.timeLine,Y=W.timeLineLength,Z=360,j=Z,q=0,_=0,ee=-1,ae=-1,ie=-1;if(i(-1,!1,Q,z)){for(var G=0;G<X.length&&i(G,!1,X[G][0],X[G][1]);G++);i(-2,!1)}r(-1),c();var te=W.allLogs,ne=W.numUnread;v(),setTimeout(function(){window.close()},6e4),$("#timerButton").click(u);var re,oe=new Date,se="",ce=[["ZYXWVUTSRQPONMLKJIHGFEDCBA",C],["VIP",T],["CHANGE",L],["TEMP",y]],le=0,de=0,fe=!1,ve=!1;$(window).keydown(function(e){if(le)if(e.keyCode===le[0].charCodeAt(de)){if(g(de,!0),++de===le[0].length){$("#phrase").addClass("done");var a=le[1];b(),a(),w()}}else g(de,!1),fe||b();else{for(var i=!1,t=0;t<ce.length;t++)e.keyCode===ce[t][0].charCodeAt(0)&&(k(ce[t][0],!0),le=ce[t],de=1,i=!0);if(!i)switch(e.keyCode){case 83:I(+$("#setTimer").val());break;case 68:ve=!0;break;case 65:M();break;case 88:P();break;case 87:I(15);break;case 69:I(30);break;case 49:case 50:case 51:case 52:case 53:case 54:if(ve){H(e.keyCode-49);break}case 55:case 56:case 57:case 58:case 48:p(e.keyCode-48);break;case 97:case 98:case 99:case 100:case 101:if(ve){H(e.keyCode-96);break}case 102:case 103:case 104:case 105:case 96:p(e.keyCode-96);break;case 38:x(1);break;case 40:x(-1)}}}).keyup(function(e){switch(e.keyCode){case 68:ve=!1}}),chrome.runtime.onMessage.addListener(function(e,n,r){if("background"===e.from)switch(e.action){case"setAlarm":var s=e.input;D(new Date(s[1]),s[0],s[2]);break;case"removeAlarm":var s=e.input;B(s[0],s[1]);break;case"ringing":F(e.input);break;case"timer":clearTimeout(R),o(e.input);break;case"change":var s=e.input;$("#"+t(s[0])).removeClass("wasting"+s[1]).addClass("wasting0");break;case"reset":a();break;case"newPage":$("#"+t(-1)).removeClass("wasting"+z).addClass("wasting0"),U=W.startTime,z=W.wastingTime,_++,i(-1,!0,new Date-U,z)}})});