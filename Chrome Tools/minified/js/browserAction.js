chrome.runtime.getBackgroundPage(function(e){function i(){clearInterval(q),clearInterval(_),Y=!1,Z=!1,V=H.timeLeft,W=H.startTime,G=H.wastingTime,O=H.url,z=H.title,J=new Date-W,$("#info").html(c(O,J,z)),U=R,j=-1,X=0,$("#timeLine").empty(),t([J,G,O],!1,-1),$("#timeLine").prepend("<div style='width:"+U+"px' class='timeLine'></div>"),o()}function t(e,i,t){var r=e[0]/N*R+X;if(X=r%1,r=Math.floor(r),1>r&&i)return X+=r,!0;var s=!0;U>r?U-=r:(r=U,U=0,s=!1);var o="";3>r||(r-=2,o=" timeLineBlock");var c=$("<div style='width:"+r+"px;' class='timeLine wasting"+e[1]+o+"' id='timeLine"+t+"'></div>");return $("#timeLine").prepend(c),n(c,e,t),i&&a(c,e),s}function a(e,i){e.hover(function(){Y=!0,$("#info").html(c(i[2],i[0],i[3]))},function(){Z||(Y=!1,$("#info").html(c(O,J,z)))})}function n(e,i,t){e.click(function(){Z=!0,j=t,$("#info").html(c(i[2],i[0],i[3]))})}function r(e){G&&(e-=new Date-W),0>e&&(e=0),s(e)}function s(e){if($("#test").html(d(e)),G&&e>0){var i=(e-1)%1e3+1;K=setTimeout(function(){s(e-i)},i)}}function o(){var e=$("#timeLine").width(),i=N/e;q=setInterval(function(){var e=$("#timeLine div:last-child"),i=$("#timeLine div:first-child");for(e.hasClass("timeLineBlock")||e.width()+1<2?e.width(e.width()+1):(e.width(e.width()-1),e.addClass("timeLineBlock"));!i.hasClass("timeLineBlock")&&i.width()<=0;)i.remove(),i=$("#timeLine div:first-child");i.hasClass("timeLineBlock")&&i.width()-1<=0?(i.width(i.width()+1),i.removeClass("timeLineBlock")):i.width(i.width()-1)},i),_=setInterval(function(){J+=1e3,Y||$("#info").html(c(O,J,z))},1e3)}function c(e,i,t){return l(t," ",50)+"<br />"+l(e,"/",50)+"<br />Time spent:"+d(i)}function l(e,i,t){if(e.length>t){var a=0;do a=e.lastIndexOf(i),e=e.substring(0,a);while(a>t);e+=i+"..."}return e}function d(e){var i=Math.ceil(e/1e3);return Math.floor(i/60)+":"+("0"+Math.floor(i%60)).slice(-2)}function h(){var e=+$("#setTimer").val();L(e)}function f(e){var i=new Date;1e3>i-ii?(ti+=e.toFixed(0),ti.length>3&&(ti=ti.substring(1)),$("#setTimer").val(ti)):(ti=e,$("#setTimer").val(ti)),ii=new Date}function m(e,i){$("#phraseHolder").remove();for(var t="<div id='phraseFront'>",a="<div id='phraseBack'>",n=0;n<e.length;n++)t+="<div id='phrase"+n+"' class='phrasePart'>"+e[n]+"</div>",a+="<div class='phrasePart'>"+e[n]+"</div>";t+="</div>",a+="</div>";var r="<div id='phraseHolder'><div id='phrase'>"+t+a+"</div></div>";$("body").prepend(r);var s=100,o=40,c=$("body").width()-o;c<$("#phraseFront").width()&&(s=Math.floor(s/($("#phraseFront").width()/c)),$(".phrasePart").css("font-size",s));var l=($("body").innerWidth()-$("#phraseFront").outerWidth())/2,d=($("body").innerHeight()-$("#phraseFront").outerHeight())/2;$("#phraseHolder").css("left",l),$("#phraseHolder").css("top",d),i&&$("#phrase0").addClass("filled"),u(1200)}function v(e,i){i?($("#phrase"+e).addClass("filled").removeClass("failed"),u(1200)):($("#phrase"+e).addClass("failed"),u(500))}function u(e){var i=.8,t=e?e/i/100:15;$("#phrase").css("opacity",i),clearInterval(ei),si||(ei=setInterval(function(){i-=.01,$("#phrase").css("opacity",i),i>0||p()},t))}function p(){ni=0,ri=0,si=!1}function k(){C("resetTime")}function w(){for(var e="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZ",t=0;18>t;t++)e+=i.charAt(Math.floor(Math.random()*i.length));ni=[e,function(){C("VIP")}],si=!0,m(e,!1)}function b(){C("change",j)}function g(){C("temp")}function C(e,i){chrome.runtime.sendMessage({from:"browserAction",action:e,input:i})}function L(e){C("setAlarm",e)}function y(e){C("removeAlarm",e)}function T(){C("stopAllAlarms")}function A(){C("snooze")}function I(e,i,t){var a=e.toLocaleTimeString();$("#alarmText"+(i+1)).html("Alarm at "+a),$("#alarm"+(i+1)).removeClass("notSet"),$("#alarm"+(i+1)).css({color:P[t],"border-color":P[t]}),$("#alarm"+(i+1)).bind("click",function(){y(i)})}function M(e){$("#alarmText"+(e+1)).html("Not Set"),$("#alarm"+(e+1)).addClass("notSet"),$("#alarm"+(e+1)).unbind("click"),$("#alarm"+(e+1)).css({color:F,"border-color":F}),$("#alarmText"+(e+1)).css("visibility","visible"),clearInterval(D[e])}function B(e){var i="hidden";D[e]=setInterval(function(){i="hidden"===i?"visible":"hidden",$("#alarmText"+(e+1)).css("visibility",i)},300)}function x(e){var i=parseInt($("#setTimer").val());(e>0||i>0)&&$("#setTimer").val(i+e)}for(var D=[0,0,0,0,0],H=e,P=e.typeColors,F=e.defaultColor,S=H.alarms,E=0;E<S.length;E++)1==S[E][0]?I(S[E][1],E,S[E][3]):2==S[E][0]&&(I(S[E][1],E,S[E][3]),B(E));var N=H.timeLineLength,V=H.timeLeft,W=H.startTime,G=H.wastingTime,O=H.url,z=H.title,J=new Date-W,K=-1;r(V),$("#info").html(c(O,J,z));var Q=H.timeLine,R=360,U=R,X=0,Y=!1,Z=!1,j=-1,q=-1,_=-1;if(t([J,G,O],!1,-1)){for(var E=0;E<Q.length&&t(Q[E],!0,E);E++);U>0&&$("#timeLine").prepend("<div style='width:"+U+"px' class='timeLine'></div>")}o(),$("#timerButton").click(h);var ei,ii=new Date,ti="",ai=[["ZYXWVUTSRQPONMLKJIHGFEDCBA",k],["VIP",w],["CHANGE",b],["TEMP",g]],ni=0,ri=0,si=!1,oi=!1;$(window).keydown(function(e){if(ni)if(e.keyCode===ni[0].charCodeAt(ri)){if(v(ri,!0),++ri===ni[0].length){$("#phrase").addClass("done");var i=ni[1];p(),i(),u()}}else v(ri,!1),si||p();else{for(var t=!1,a=0;a<ai.length;a++)e.keyCode===ai[a][0].charCodeAt(0)&&(m(ai[a][0],!0),ni=ai[a],ri=1,t=!0);if(!t)switch(e.keyCode){case 83:L(+$("#setTimer").val());break;case 68:oi=!0;break;case 65:T();break;case 88:A();break;case 87:L(15);break;case 69:L(30);break;case 49:case 50:case 51:case 52:case 53:case 54:if(oi){y(e.keyCode-49);break}case 55:case 56:case 57:case 58:case 48:f(e.keyCode-48);break;case 97:case 98:case 99:case 100:case 101:if(oi){y(e.keyCode-96);break}case 102:case 103:case 104:case 105:case 96:f(e.keyCode-96);break;case 38:x(1);break;case 40:x(-1)}}}).keyup(function(e){switch(e.keyCode){case 68:oi=!1}}),chrome.runtime.onMessage.addListener(function(e){if("background"===e.from)switch(e.action){case"setAlarm":var t=e.input;I(new Date(t[1]),t[0],t[2]);break;case"removeAlarm":var t=e.input;M(t[0],t[1]);break;case"ringing":B(e.input);break;case"timer":clearTimeout(K),r(e.input);break;case"change":var t=e.input;$("#timeLine"+t[0]).removeClass("wasting"+t[1]).addClass("wasting0"),-1===t[0]&&(G=0);break;case"reset":i()}})});