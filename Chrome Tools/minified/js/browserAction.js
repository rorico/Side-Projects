chrome.runtime.getBackgroundPage(function(e){function t(){clearInterval(X),clearInterval(Z),j=!1,K=!1,H=B.timeLeft,q=B.startTime,_=B.wastingTime,W=B.url,E=B.title,N=new Date-q,$("#info").html(l(W,N,E)),G=J,Q=-1,Y=0,$("#timeLine").empty(),r([N,_,W],!1,-1),$("#timeLine").prepend("<div style='width:"+G+"px' class='timeLine'></div>"),o()}function r(e,t,r){var i=e[0]/O*J+Y;if(Y=i%1,i=Math.floor(i),1>i&&t)return Y+=i,!0;var s=!0;G>i?G-=i:(i=G,G=0,s=!1);var o="";3>i||(i-=2,o=" timeLineBlock");var l=$("<div style='width:"+i+"px;' class='timeLine wasting"+e[1]+o+"' id='timeLine"+r+"'></div>");return $("#timeLine").prepend(l),n(l,e,r),t&&a(l,e),s}function a(e,t){e.hover(function(){j=!0,$("#info").html(l(t[2],t[0],t[3]))},function(){K||(j=!1,$("#info").html(l(W,N,E)))})}function n(e,t,r){e.click(function(){K=!0,Q=r,$("#info").html(l(t[2],t[0],t[3]))})}function i(e){_&&(e-=new Date-q),0>e&&(e=0),s(e)}function s(e){if($("#test").html(m(e)),_&&e>0){var t=(e-1)%1e3+1;z=setTimeout(function(){s(e-t)},t)}}function o(){var e=$("#timeLine").width(),t=O/e;X=setInterval(function(){var e=$("#timeLine div:last-child"),t=$("#timeLine div:first-child");for(e.hasClass("timeLineBlock")||e.width()+1<2?e.width(e.width()+1):(e.width(e.width()-1),e.addClass("timeLineBlock"));!t.hasClass("timeLineBlock")&&t.width()<=0;)t.remove(),t=$("#timeLine div:first-child");t.hasClass("timeLineBlock")&&t.width()-1<=0?(t.width(t.width()+1),t.removeClass("timeLineBlock")):t.width(t.width()-1)},t),Z=setInterval(function(){N+=1e3,j||$("#info").html(l(W,N,E))},1e3)}function l(e,t,r){return c(r," ",50)+"<br />"+c(e,"/",50)+"<br />Time spent:"+m(t)}function c(e,t,r){if(e.length>r){var a=0;do a=e.lastIndexOf(t),e=e.substring(0,a);while(a>r);e+=t+"..."}return e}function m(e){var t=Math.ceil(e/1e3);return Math.floor(t/60)+":"+("0"+Math.floor(t%60)).slice(-2)}function u(){var e=+$("#setTimer").val();w(e)}function d(e){var t=new Date;1e3>t-tt?(rt+=e.toFixed(0),rt.length>3&&(rt=rt.substring(1)),$("#setTimer").val(rt)):(rt=e,$("#setTimer").val(rt)),tt=new Date}function h(e,t){$("#phraseHolder").remove();for(var r="<div id='phraseFront'>",a="<div id='phraseBack'>",n=0;n<e.length;n++)r+="<div id='phrase"+n+"' class='phrasePart'>"+e[n]+"</div>",a+="<div class='phrasePart'>"+e[n]+"</div>";r+="</div>",a+="</div>";var i="<div id='phraseHolder'><div id='phrase'>"+r+a+"</div></div>";$("body").prepend(i);var s=100,o=40,l=$("body").width()-o;l<$("#phraseFront").width()&&(s=Math.floor(s/($("#phraseFront").width()/l)),$(".phrasePart").css("font-size",s));var c=($("body").innerWidth()-$("#phraseFront").outerWidth())/2,m=($("body").innerHeight()-$("#phraseFront").outerHeight())/2;$("#phraseHolder").css("left",c),$("#phraseHolder").css("top",m),t&&$("#phrase0").addClass("filled"),g(1200)}function f(e,t){t?($("#phrase"+e).addClass("filled").removeClass("failed"),g(1200)):($("#phrase"+e).addClass("failed"),g(500))}function g(e){var t=.8,r=e?e/t/100:15;$("#phrase").css("opacity",t),clearInterval(et),st||(et=setInterval(function(){t-=.01,$("#phrase").css("opacity",t),t>0||p()},r))}function p(){nt=0,it=0,st=!1}function v(){b("resetTime")}function A(){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZ",r=0;18>r;r++)e+=t.charAt(Math.floor(Math.random()*t.length));nt=[e,function(){b("VIP")}],st=!0,h(e,!1)}function T(){b("change",Q)}function y(){b("temp")}function b(e,t){chrome.runtime.sendMessage({from:"browserAction",action:e,input:t})}function w(e){b("setAlarm",e)}function C(e){b("removeAlarm",e)}function k(){b("stopAllAlarms")}function I(){b("snooze")}function L(e,t,r){var a=e.toLocaleTimeString();$("#alarmText"+(t+1)).html("Alarm at "+a),$("#alarm"+(t+1)).removeClass("notSet"),$("#alarm"+(t+1)).css({color:R[r],"border-color":R[r]}),$("#alarm"+(t+1)).bind("click",function(){C(t)})}function M(e){$("#alarmText"+(e+1)).html("Not Set"),$("#alarm"+(e+1)).addClass("notSet"),$("#alarm"+(e+1)).unbind("click"),$("#alarm"+(e+1)).css({color:P,"border-color":P}),$("#alarmText"+(e+1)).css("visibility","visible"),clearInterval(S[e])}function x(e){var t="hidden";S[e]=setInterval(function(){t="hidden"===t?"visible":"hidden",$("#alarmText"+(e+1)).css("visibility",t)},300)}function D(e){var t=parseInt($("#setTimer").val());(e>0||t>0)&&$("#setTimer").val(t+e)}for(var S=[0,0,0,0,0],B=e,R=e.typeColors,P=e.defaultColor,F=B.alarms,V=0;V<F.length;V++)1==F[V][0]?L(F[V][1],V,F[V][3]):2==F[V][0]&&(L(F[V][1],V,F[V][3]),x(V));var O=B.timeLineLength,H=B.timeLeft,q=B.startTime,_=B.wastingTime,W=B.url,E=B.title,N=new Date-q,z=-1;i(H),$("#info").html(l(W,N,E));var U=B.timeLine,J=360,G=J,Y=0,j=!1,K=!1,Q=-1,X=-1,Z=-1;if(r([N,_,W],!1,-1)){for(var V=0;V<U.length&&r(U[V],!0,V);V++);G>0&&$("#timeLine").prepend("<div style='width:"+G+"px' class='timeLine'></div>")}o(),$("#timerButton").click(u);var et,tt=new Date,rt="",at=[["ZYXWVUTSRQPONMLKJIHGFEDCBA",v],["VIP",A],["CHANGE",T],["TEMP",y]],nt=0,it=0,st=!1,ot=!1;$(window).keydown(function(e){if(nt)if(e.keyCode===nt[0].charCodeAt(it)){if(f(it,!0),++it===nt[0].length){$("#phrase").addClass("done");var t=nt[1];p(),t(),g()}}else f(it,!1),st||p();else{for(var r=!1,a=0;a<at.length;a++)e.keyCode===at[a][0].charCodeAt(0)&&(h(at[a][0],!0),nt=at[a],it=1,r=!0);if(!r)switch(e.keyCode){case 83:w(+$("#setTimer").val());break;case 68:ot=!0;break;case 65:k();break;case 88:I();break;case 87:w(15);break;case 69:w(30);break;case 49:case 50:case 51:case 52:case 53:case 54:if(ot){C(e.keyCode-49);break}case 55:case 56:case 57:case 58:case 48:d(e.keyCode-48);break;case 97:case 98:case 99:case 100:case 101:if(ot){C(e.keyCode-96);break}case 102:case 103:case 104:case 105:case 96:d(e.keyCode-96);break;case 38:D(1);break;case 40:D(-1)}}}).keyup(function(e){switch(e.keyCode){case 68:ot=!1}}),chrome.runtime.onMessage.addListener(function(e){if("background"===e.from)switch(e.action){case"setAlarm":var r=e.input;L(new Date(r[1]),r[0],r[2]);break;case"removeAlarm":var r=e.input;M(r[0],r[1]);break;case"ringing":x(e.input);break;case"timer":clearTimeout(z),i(e.input);break;case"change":var r=e.input;$("#timeLine"+r[0]).removeClass("wasting"+r[1]).addClass("wasting0"),-1===r[0]&&(_=0);break;case"reset":t()}})});