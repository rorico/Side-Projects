chrome.runtime.getBackgroundPage(function(e){function t(){clearInterval(j),clearInterval(q),X=!1,Y=!1,z=D.timeLeft,E=D.startTime,G=D.wastingTime,H=D.url,O=D.title,J=new Date-E,$("#info").html(c(H,J,O)),U=R,Z=-1,W=0,$("#timeLine").empty(),i([J,G,H],!1,-1),$("#timeLine").prepend('<div style="width:'+U+'px" class="timeLine"></div>'),o()}function i(e,t,i){var r=e[0]/V*R+W;if(W=r%1,r=Math.floor(r),1>r&&t)return W+=r,!0;var s=!0;U>r?U-=r:(r=U,U=0,s=!1);var o="";3>r||(r-=2,o=" timeLineBlock");var c=$('<div style="width:'+r+'px;" class="timeLine wasting'+e[1]+o+'" id="timeLine'+i+'"></div>');return $("#timeLine").prepend(c),n(c,e,i),t&&a(c,e),s}function a(e,t){e.hover(function(){X=!0,$("#info").html(c(t[2],t[0],t[3]))},function(){Y||(X=!1,$("#info").html(c(H,J,O)))})}function n(e,t,i){e.click(function(){Y=!0,Z=i,$("#info").html(c(t[2],t[0],t[3]))})}function r(e){G&&(e-=new Date-E),0>e&&(e=0),s(e)}function s(e){if($("#test").html(d(e)),G&&e>0){var t=(e-1)%1e3+1;K=setTimeout(function(){s(e-t)},t)}}function o(){var e=$("#timeLine").width(),t=V/e;j=setInterval(function(){var e=$("#timeLine div:last-child"),t=$("#timeLine div:first-child");for(e.hasClass("timeLineBlock")||e.width()+1<2?e.width(e.width()+1):(e.width(e.width()-1),e.addClass("timeLineBlock"));!t.hasClass("timeLineBlock")&&t.width()<=0;)t.remove(),t=$("#timeLine div:first-child");t.hasClass("timeLineBlock")&&t.width()-1<=0?(t.width(t.width()+1),t.removeClass("timeLineBlock")):t.width(t.width()-1)},t),q=setInterval(function(){J+=1e3,X||$("#info").html(c(H,J,O))},1e3)}function c(e,t,i){return l(i," ",50)+"<br />"+l(e,"/",50)+"<br />Time spent:"+d(t)}function l(e,t,i){if(e.length>i){var a=0;do a=e.lastIndexOf(t),e=e.substring(0,a);while(a>i);e+=t+"..."}return e}function d(e){var t=Math.ceil(e/1e3);return Math.floor(t/60)+":"+("0"+Math.floor(t%60)).slice(-2)}function h(){var e=+$("#setTimer").val();L(e)}function m(e){var t=new Date;1e3>t-et?(tt+=e.toFixed(0),tt.length>3&&(tt=tt.substring(1)),$("#setTimer").val(tt)):(tt=e,$("#setTimer").val(tt)),et=new Date}function f(e){$("#phrase").remove();for(var t="<div id='phraseFront'>",i="<div id='phraseBack'>",a=0;a<e.length;a++)t+="<div id='phrase"+a+"' class='phrasePart'>"+e[a]+"</div>",i+="<div class='phrasePart'>"+e[a]+"</div>";t+="</div>",i+="</div>";var n="<div id='phrase'>"+t+i+"</div>";$("body").append(n);var r=100;$("body").width()<$("#phraseFront").width()&&(r=Math.floor(r/($("#phraseFront").width()/$("body").width())),$(".phrasePart").css("font-size",r));var s=($("body").width()-$("#phraseFront").width())/2,o=($("body").height()-$("#phraseFront").height())/2;$("#phraseFront").css("left",s),$("#phraseFront").css("top",o),$("#phraseBack").css("left",s),$("#phraseBack").css("top",o),$("#phrase0").addClass("filled"),u()}function v(e){$("#phrase"+e).addClass("filled"),u()}function u(){var e=.8;clearInterval(_),_=setInterval(function(){e-=.01,$("#phrase").css("opacity",e),e>0||p()},10)}function p(){at=-1,nt=0,clearInterval(_),$("#phrase").remove()}function k(){g("resetTime")}function w(){g("VIP")}function b(){g("change",Z)}function g(e,t){chrome.runtime.sendMessage({from:"browserAction",action:e,input:t})}function L(e){g("setAlarm",e)}function C(e){g("removeAlarm",e)}function y(){g("stopAllAlarms")}function T(){g("snooze")}function I(e,t,i){var a=e.toLocaleTimeString();$("#alarmText"+(t+1)).html("Alarm at "+a),$("#alarm"+(t+1)).removeClass("notSet"),$("#alarm"+(t+1)).css({color:M[i],"border-color":M[i]}),$("#alarm"+(t+1)).bind("click",function(){C(t)})}function A(e){$("#alarmText"+(e+1)).html("Not Set"),$("#alarm"+(e+1)).addClass("notSet"),$("#alarm"+(e+1)).unbind("click"),$("#alarm"+(e+1)).css({color:P,"border-color":P}),$("#alarmText"+(e+1)).css("visibility","visible"),clearInterval(F[e])}function B(e){var t="hidden";F[e]=setInterval(function(){t="hidden"===t?"visible":"hidden",$("#alarmText"+(e+1)).css("visibility",t)},300)}function x(e){var t=parseInt($("#setTimer").val());(e>0||t>0)&&$("#setTimer").val(t+e)}for(var F=[0,0,0,0,0],D=e,M=e.typeColors,P=e.defaultColor,S=D.alarms,N=0;N<S.length;N++)1==S[N][0]?I(S[N][1],N,S[N][3]):2==S[N][0]&&(I(S[N][1],N,S[N][3]),B(N));var V=D.timeLineLength,z=D.timeLeft,E=D.startTime,G=D.wastingTime,H=D.url,O=D.title,J=new Date-E,K=-1;r(z),$("#info").html(c(H,J,O));var Q=D.timeLine,R=360,U=R,W=0,X=!1,Y=!1,Z=-1,j=-1,q=-1;if(i([J,G,H],!1,-1)){for(var N=0;N<Q.length&&i(Q[N],!0,N);N++);U>0&&$("#timeLine").prepend('<div style="width:'+U+'px" class="timeLine"></div>')}o(),$("#timerButton").click(h);var _,et=new Date,tt="",it=[["ZYXWVUTSRQPONMLKJIHGFEDCBA",k],["VIP",w],["CHANGE",b]],at=-1,nt=0,rt=!1;$(window).keydown(function(e){if(-1!==at)e.keyCode===it[at][0].charCodeAt(nt)?(v(nt),++nt===it[at][0].length&&it[at][1]()):p();else{for(var t=!1,i=0;i<it.length;i++)e.keyCode===it[i][0].charCodeAt(0)&&(f(it[i][0]),at=i,nt=1,t=!0);if(!t)switch(e.keyCode){case 83:L(+$("#setTimer").val());break;case 68:rt=!0;break;case 65:y();break;case 88:T();break;case 87:L(15);break;case 69:L(30);break;case 49:case 50:case 51:case 52:case 53:case 54:if(rt){C(e.keyCode-49);break}case 55:case 56:case 57:case 58:case 48:m(e.keyCode-48);break;case 97:case 98:case 99:case 100:case 101:if(rt){C(e.keyCode-96);break}case 102:case 103:case 104:case 105:case 96:m(e.keyCode-96);break;case 38:x(1);break;case 40:x(-1)}}}).keyup(function(e){switch(e.keyCode){case 68:rt=!1}}),chrome.runtime.onMessage.addListener(function(e){if("background"===e.from)switch(e.action){case"setAlarm":var i=e.input;I(new Date(i[1]),i[0],i[2]);break;case"removeAlarm":var i=e.input;A(i[0],i[1]);break;case"ringing":B(e.input);break;case"timer":clearTimeout(K),r(e.input);break;case"change":var i=e.input;$("#timeLine"+i[0]).removeClass("wasting"+i[1]).addClass("wasting0"),-1===i[0]&&(G=0);break;case"reset":t()}})});