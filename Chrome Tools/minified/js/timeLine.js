var currentTimePiece=-1,timeLineInit,countDown,addTimeLine,changeTimeLine,restartTimeLine,newPage,keyPhrases;!function(){function e(e){return e===-2?"timeLineP":"timeLine"+(e-D)}function i(e,i){e.click(function(){currentTimePiece=i+D,t(currentTimePiece)}),e.hover(function(){t(i+D)},function(){t(currentTimePiece)})}function t(e){clearTimeout(b);var i="";if(e===-1){w=new Date-v;var n=1e3-w%1e3;b=setTimeout(function(){t(e)},n),i=r(L,w,T)}else i=r(g[e][2],g[e][0],g[e][3]);$("#info").html(i)}function n(e){if($("#timeLeft").html(c(e,!1)),h&&e>0){var i=(e-1)%1e3+1;p=setTimeout(function(){n(e-i)},i)}}function a(){var e=P/k;M=setInterval(function(){var e=$("#timeLine div:last-child");e.width(e.width()+1),!e.hasClass("timeLineBlock")&&e.width()>=3&&e.addClass("timeLineBlock");for(var i=$("#timeLine div:first-child");i.length&&i.width()<=0;)i.remove(),i=$("#timeLine div:first-child");i.width(i.width()-1),i.hasClass("timeLineBlock")&&i.width()<3&&i.removeClass("timeLineBlock")},e)}function r(e,i,t){return o(t," ",50)+"<br />"+o(e,"/",50)+"<br />Time spent:"+c(i,!0)}function o(e,i,t){if(e.length>t){var n=0;do n=e.lastIndexOf(i),e=e.substring(0,n);while(n>t);e+=i+"..."}return e}function c(e,i){var t=i?Math.floor(e/1e3):Math.ceil(e/1e3);return Math.floor(t/60)+":"+("0"+Math.floor(t%60)).slice(-2)}function m(){l("resetTime")}function s(){l("VIP")}function d(){l("change",currentTimePiece)}function u(){l("temp")}function l(e,i){chrome.runtime.sendMessage({from:"browserAction",action:e,input:i})}var f,v,h,L,T,w,g,P,p=-1,k=360,I=k,C=0,D=0,M=-1,b=-1;keyPhrases=[["ZYXWVUTSRQPONMLKJIHGFEDCBA",m],["VIP",s,1],["CHANGE",d],["TEMP",u]],timeLineInit=function(e,i){var n=e.width()-30;k=60*Math.floor(n/60);for(var o="<div id='axisTop'>",c="<div id='axisBot'>",m=0;m<6;m++)o+="<div class='axisPart top"+(5===m?" end":"")+"'></div>",c+="<div class='axisPart bot"+(5===m?" end":"")+"'></div>";o+="</div>",c+="</div>";var s="<div id='chromeTools_timeLine'><div id='timeLeft'></div><div id='timeLineHolder'>"+o+"<div id='timeLine'></div>"+c+"</div><div id='info'></div></div>";if(e.html(s),$(".axisPart").outerWidth(k/6),f=i.timeLeft,v=i.startTime,h=i.wastingTime,L=i.url,T=i.title,w=new Date-v,p=-1,countDown(f),I=k,C=0,D=0,clearInterval(M),clearInterval(b),$("#info").html(r(L,w,T)),g=i.timeLine,P=i.timeLineLength,addTimeLine(-1,!1,w,h)){for(var m=0;m<g.length&&addTimeLine(m,!1,g[m][0],g[m][1]);m++);addTimeLine(-2,!1)}t(-1),a();var d=(e.innerHeight()-$("#chromeTools_timeLine").outerHeight())/2;$("#chromeTools_timeLine").css("top",d)},restartTimeLine=function(e){clearInterval(M),clearInterval(b),f=e.timeLeft,v=e.startTime,h=e.wastingTime,L=e.url,T=e.title,w=new Date-v,$("#info").html(r(L,w,T)),I=k,currentTimePiece=-1,C=0,$("#timeLine").empty(),addTimeLine(-1,!1,w,h),addTimeLine(-2,!1),t(-1),a()},addTimeLine=function(t,n,a,r){var o=0;if(o=t===-2?I:a/P*k+C,C=o%1,o=Math.floor(o),o<1&&t!==-1)return C+=o,!0;var c=!0;o>=I?(o=I,I=0,c=!1):I-=o;var m="timeLine";t!==-2&&(m+=" wasting"+r,o>=3&&(m+=" timeLineBlock"));var s=$("<div style='width:"+o+"px;' class='"+m+"' id='"+e(t)+"'></div>");return n?$("#timeLine").append(s):$("#timeLine").prepend(s),t!==-2&&i(s,t),c},changeTimeLine=function(i,t){$("#"+e(i)).removeClass("wasting"+t).addClass("wasting0")},newPage=function(i,t){$("#"+e(-1)).removeClass("wasting"+h).addClass("wasting0"),v=i,h=t,D++,addTimeLine(-1,!0,new Date-i,t)},countDown=function(e){h&&(e-=new Date-v),e<0&&(e=0),clearTimeout(p),n(e)},chrome.runtime.onMessage.addListener(function(e,i,t){if("background"===e.from)switch(e.action){case"timer":countDown(e.input);break;case"change":var n=e.input;changeTimeLine(n[0],n[1]);break;case"reset":restartTimeLine(e.input);break;case"newPage":var n=e.input;newPage(n.startTime,n.wastingTime)}})}();