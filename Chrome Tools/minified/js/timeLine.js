var currentTimePiece=-1,timeLineInit,countDown,addTimeLine,changeTimeLine,restartTimeLine,newPage,keyPhrases;!function(){function e(e){return e-b}function i(i){return i===-2?"timeLineP":"timeLine"+e(i)}function t(e,i){e.click(function(){currentTimePiece=i+b,n(currentTimePiece)}),e.hover(function(){n(i+b)},function(){n(currentTimePiece)})}function n(e){clearTimeout(x);var i="";if(e===-1){g=new Date-h;var t=1e3-g%1e3;x=setTimeout(function(){n(e)},t),i=o(T,g,w)}else i=o(P[e][2],P[e][0],P[e][3]);$("#info").html(i)}function r(e){if($("#timeLeft").html(m(e,!1)),L&&e>0){var i=(e-1)%1e3+1;k=setTimeout(function(){r(e-i)},i)}}function a(){var e=p/I;C=setInterval(function(){var e=$("#timeLine div:last-child");e.width(e.width()+1),!e.hasClass("timeLineBlock")&&e.width()>=3&&e.addClass("timeLineBlock");for(var i=$("#timeLine div:first-child");i.length&&i.width()<=0;)i.remove(),i=$("#timeLine div:first-child");i.width(i.width()-1),i.hasClass("timeLineBlock")&&i.width()<3&&i.removeClass("timeLineBlock")},e)}function o(e,i,t){return c(t," ",50)+"<br />"+c(e,"/",50)+"<br />Time spent:"+m(i,!0)}function c(e,i,t){if(e.length>t){var n=0;do n=e.lastIndexOf(i),e=e.substring(0,n);while(n>t);e+=i+"..."}return e}function m(e,i){var t=i?Math.floor(e/1e3):Math.ceil(e/1e3);return Math.floor(t/60)+":"+("0"+Math.floor(t%60)).slice(-2)}function s(){f("resetTime")}function d(){f("VIP")}function u(){f("change",currentTimePiece)}function l(){f("temp")}function f(e,i){chrome.runtime.sendMessage({from:"browserAction",action:e,input:i})}var v,h,L,T,w,g,P,p,k=-1,I=360,D=I,M=0,b=0,C=-1,x=-1;keyPhrases=[["ZYXWVUTSRQPONMLKJIHGFEDCBA",s],["VIP",d,1],["CHANGE",u],["TEMP",l]],timeLineInit=function(e,i){var t=e.width()-30;I=60*Math.floor(t/60);for(var r="<div id='axisTop'>",c="<div id='axisBot'>",m=0;m<6;m++)r+="<div class='axisPart top"+(5===m?" end":"")+"'></div>",c+="<div class='axisPart bot"+(5===m?" end":"")+"'></div>";r+="</div>",c+="</div>";var s="<div id='chromeTools_timeLine'><div id='timeLeft'></div><div id='timeLineHolder'>"+r+"<div id='timeLine'></div>"+c+"</div><div id='info'></div></div>";if(e.html(s),$(".axisPart").outerWidth(I/6),v=i.timeLeft,h=i.startTime,L=i.wastingTime,T=i.url,w=i.title,g=new Date-h,k=-1,countDown(v),D=I,M=0,b=0,clearInterval(C),clearInterval(x),$("#info").html(o(T,g,w)),P=JSON.parse(JSON.stringify(i.timeLine)),p=i.timeLineLength,addTimeLine(-1,!1,g,L)){for(var m=0;m<P.length&&addTimeLine(m,!1,P[m][0],P[m][1]);m++);addTimeLine(-2,!1)}n(-1),a();var d=(e.innerHeight()-$("#chromeTools_timeLine").outerHeight())/2;$("#chromeTools_timeLine").css("top",d)},restartTimeLine=function(e){clearInterval(C),clearInterval(x),v=e.timeLeft,h=e.startTime,L=e.wastingTime,T=e.url,w=e.title,g=new Date-h,$("#info").html(o(T,g,w)),D=I,currentTimePiece=-1,M=0,$("#timeLine").empty(),addTimeLine(-1,!1,g,L),addTimeLine(-2,!1),n(-1),a()},addTimeLine=function(n,r,a,o){var c=0;if(c=n===-2?D:a/p*I+M,M=c%1,c=Math.floor(c),c<1&&n!==-1)return M+=c,!0;var m=!0;c>=D?(c=D,D=0,m=!1):D-=c;var s="timeLine";n!==-2&&(s+=" wasting"+o,c>=3&&(s+=" timeLineBlock"));var d=$("<div style='width:"+c+"px;' class='"+s+"' id='"+i(n)+"'></div>");return r?$("#timeLine").append(d):$("#timeLine").prepend(d),n!==-2&&t(d,e(n)),m},changeTimeLine=function(e,t){$("#"+i(e)).removeClass("wasting"+t).addClass("wasting0")},newPage=function(e){h=e.startTime,L=e.wastingTime,T=e.url,w=e.title,P.unshift(e.newest),b++,addTimeLine(-1,!0,new Date-h,L)},countDown=function(e){L&&(e-=new Date-h),e<0&&(e=0),clearTimeout(k),r(e)},chrome.runtime.onMessage.addListener(function(e,i,t){if("background"===e.from)switch(e.action){case"timer":countDown(e.input);break;case"change":var n=e.input;changeTimeLine(n[0],n[1]);break;case"reset":restartTimeLine(e.input);break;case"newPage":newPage(e.input)}})}();