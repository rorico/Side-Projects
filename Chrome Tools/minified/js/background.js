function sendFormat(e,t){return{from:"background",action:e,input:t}}function sendRequest(e,t){chrome.runtime.sendMessage(sendFormat(e,t))}function log(e){addLog(JSON.stringify(e)),console.log(e)}function addLog(e){allLogs.push([e,!0]),numUnread++}function removeLog(e){allLogs[e][1]&&(allLogs[e][1]=!1,numUnread--)}function setTimer(e,t){if(!t||t<timerThreshold)return timerHandlers[++curTimerId]=[0,setTimeout(e,t)],curTimerId;for(var n=0,r=+new Date+t,i=0;i<timerQueue.length&&!(r<timerQueue[i][1]);i++)n++;return timerQueue.splice(n,0,[++curTimerId,r,e]),n||(chrome.alarms.clearAll(),chrome.alarms.create("timer",{when:r})),timerHandlers[curTimerId]=[1],curTimerId}function clearTimer(e){var t=timerHandlers[e];if(t)if(t[0]){for(var n=0;n<timerQueue.length;n++)if(e===timerQueue[n][0]){timerQueue.splice(n,1),0===n&&(chrome.alarms.clearAll(),chrome.alarms.create("timer",{when:timerQueue[0][1]}));break}}else clearTimeout(t[1])}function setIframeInfo(){chrome.storage.sync.get("iframeInfo",function(e){if(chrome.runtime.lastError&&log(chrome.runtime.lastError),e.iframeInfo){iframeInfo=e.iframeInfo;for(var t=[],n=0;n<iframeInfo.length;n++)t.push(iframeInfo[n].url);chrome.webRequest.onHeadersReceived.addListener(function(e){for(var t=e.responseHeaders||[],n=t.length-1;n>=0;n--){var r=t[n].name.toLowerCase();"x-frame-options"!==r&&"frame-options"!==r||t.splice(n,1)}return{responseHeaders:t}},{urls:t,types:["sub_frame"]},["blocking","responseHeaders"])}else iframeInfo=[]})}function addScheduleListener(e){scheduleListeners.push(e)}function setScheduleInfo(){chrome.storage.sync.get("scheduleInfo",function(e){chrome.runtime.lastError&&log(chrome.runtime.lastError),e.scheduleInfo?(scheduleInfo=e.scheduleInfo,today=todaySchedule(date)):(scheduleInfo=[],today=[]);for(var t=0;t<scheduleListeners.length;t++)scheduleListeners[t](today)})}function weekSchedule(e,t){for(var n=[],r=0;r<e.length;r++)n.push(todaySchedule(e[r]));t(n)}function setSleepAlarm(){var e=new Date;e.setSeconds(0),e.setMinutes(30*Math.floor(e.getMinutes()/30)+30),e.getHours()<sleepAlarmStart&&e.getHours()>sleepAlarmEnd&&(e.setHours(sleepAlarmStart),e.setMinutes(0)),setTimer(function(){setAlarm(0,1),setSleepAlarm()},e-new Date)}function setAlarm(e,t){for(var n=0;n<numMaxAlarms;n++){var r=alarms[n];if(!r){var i=new Date;i.setMinutes(i.getMinutes()+e);var o=setRing(n,t,e);alarmCnt++,alarmTypeCnt[t]++,t>alarmTypeMax&&(chrome.browserAction.setBadgeBackgroundColor({color:typeColors[t]}),alarmTypeMax=t);var a={state:1,alarmTime:i,type:t,destructor:o};return alarms[n]=a,void sendRequest("setAlarm",[n,+i,t])}}}function setRing(e,t,n){var r,i=setTimer(function(){ringingCnt++,alarms[e].state=2,playAlarmCheck=!0,sendRequest("ringing",e),chrome.windows.getAll(function(n){n.length&&(audio.play(),1===t&&(r=setTimeout(function(){removeAlarm(e,t),setAlarm(5,1)},5e3)))})},6e4*n);return function(){clearTimer(i),clearTimeout(r)}}function removeAlarm(e,t){var n=alarms[e];if(n&&("undefined"==typeof t&&2!==n.type||n.type==t)){if(alarmTypeCnt[t]--,--alarmCnt){for(var r=alarmTypeMax;r>=0;r--)if(alarmTypeCnt[r]){alarmTypeMax=r,chrome.browserAction.setBadgeBackgroundColor({color:typeColors[r]});break}}else alarmTypeMax=-1,chrome.browserAction.setBadgeBackgroundColor({color:defaultColor});return playAlarmCheck&&2===n.state&&(--ringingCnt||(playAlarmCheck=!1,audio.pause(),audio.currentTime=0)),n.destructor(),alarms[e]=void 0,sendRequest("removeAlarm",[e,n.type]),!0}return!1}function stopAllAlarms(e){var t=!1;if(playAlarmCheck)for(var n=0;n<alarms.length;n++)alarms[n]&&2===alarms[n].state&&(t|=removeAlarm(n,e));return t}function snooze(){stopAllAlarms()&&setAlarm(5,0)}var addMessageListener;!function(){var e={};addMessageListener=function(t){for(var n in t)e[n]=t[n]},chrome.runtime.onMessage.addListener(function(t,n,r){if("background"!==t.from){var i=e[t.action];"function"==typeof i&&i(t,n,r)}})}();var allLogs=[],numUnread=0;addMessageListener({removeLog:function(e){removeLog(e.input)}}),window.onerror=function(e,t,n,r,i){addLog(e)};var storeData,getData;!function(){function e(e,o,c){var l=e+s,m=e+u;r([l,m],function(s){var u=s[l]||[],f=s[m]||{},d=function(){var n=e+"_"+u.length;u.push(n);var r={indexes:u};r[l]=u,r[e+a]=[],r[n]=o,r[m]=f,t(r),storeData(e,c)};f.sync||(f.sync=[0,u.length]),f.sync[1]++;var h=f.sync[1]-f.sync[0]-3;if(h>0){f.local||(f.local=[0,0]),f.local[1]+=h;var g=u.slice(f.sync[0],f.sync[0]+h);f.sync[0]+=h,r(g,function(e){n(e),i(g,d)})}else d()})}function t(e,t,n){chrome.storage.sync.set(e,function(){o(n)||"function"!=typeof t||t()})}function n(e,t,n){chrome.storage.local.set(e,function(){o(n)||"function"!=typeof t||t()})}function r(e,t,n){chrome.storage.sync.get(e,function(e){o(n)||"function"!=typeof t||t(e)})}function i(e,t,n){chrome.storage.sync.remove(e,function(){o(n)||"function"!=typeof t||t()})}function o(e){return!!chrome.runtime.lastError&&("function"==typeof e&&e(chrome.runtime.lastError.message),log(chrome.runtime.lastError.message),!0)}var a="s",s="Indexes",u="Meta";storeData=function(n,i){var o=n+a;r(o,function(r){var a=r[o]||[],s=7e3;if(JSON.stringify(i).length>s)log("can't store the following, too large:"),log(i);else if(JSON.stringify(a).length+JSON.stringify(i).length>s)e(n,a,i);else{a.push(i);var u={};u[o]=a,t(u,null,function(t){"QUOTA_BYTES quota exceeded"===t&&e(n,a,i)})}})},getData=function(e,t){var n=e+s,i=e+u;r([n,i],function(o){var s=o[n]||[],u=o[i]||{};u.sync&&(s=s.slice(u.sync[0],u.sync[1])),s.push(e+a),r(s,t)})}}();var timerThreshold=3e5,timerQueue=[],curTimerId=0,timerHandlers=[];chrome.alarms.onAlarm.addListener(function(e){if("timer"===e.name){for(var t=+new Date+timerThreshold,n=0,r=0;r<timerQueue.length&&timerQueue[r][1]<t;r++)timerHandlers[timerQueue[r][0]]=setTimeout(timerQueue[r][2],timerQueue[r][1]-new Date),n++;timerQueue.splice(0,n),timerQueue.length&&chrome.alarms.create("timer",{when:timerQueue[0][1]})}});var iframeInfo;setIframeInfo();var scheduleInfo,date=new Date,today;setScheduleInfo(),addMessageListener({resetSchedule:setScheduleInfo,weekSchedule:function(e,t,n){weekSchedule(e.input,n)}});var scheduleListeners=[],todaySchedule=function(){function e(e){for(var i=[],o=0;o<scheduleInfo.length;o++)for(var a=0;a<scheduleInfo[o][1].length;a++)for(var s=0;s<scheduleInfo[o][1][a][1].length;s++){var u=scheduleInfo[o][1][a][1][s];t(e,u[0][0])&&n(e,u[2])&&i.push([u[0],u[1],scheduleInfo[o][0],scheduleInfo[o][1][a][0]])}return i.sort(r),i}function t(e,t){var n=new Date(e).getDay(),r=-1;switch(n){case 1:r="M";break;case 2:r="T";break;case 3:r="W";break;case 4:r="Th";break;case 5:r="F"}var i=t.indexOf(r);return i>-1&&("T"!==r||"h"!==t[i+1])}function n(e,t){return e>=t[0]&&e<=t[1]}function r(e,t){return e[0][1]<t[0][1]?-1:e[0][1]>t[0][1]?1:0}return e}(),alarms=[],numMaxAlarms=3,typeColors=["#0000FF","#33FFFF","#FF0000"],defaultColor="#000000",alarmCnt=0,ringingCnt=0,alarmTypeCnt=[0,0,0],alarmTypeMax=-1,audio=new Audio("/alarm.mp3");audio.loop=!0;var playAlarmCheck=!1;chrome.browserAction.setBadgeBackgroundColor({color:defaultColor});var sleepAlarmStart=22,sleepAlarmEnd=6;setSleepAlarm(),addMessageListener({stopAllAlarms:stopAllAlarms,snooze:snooze,setAlarm:function(e){setAlarm(e.input,0)},removeAlarm:function(e){removeAlarm(e.input)}});var youtubeVideoNames=[];!function(){function e(e){var t={url:["*://*.youtube.com/*","*://youtube.com/*"]};isBlocked()||(t.active=!1),chrome.tabs.query(t,e)}function t(t){"number"==typeof t?(s(c.splice(t,1)[0]),youtubeVideoNames.splice(t,1)):e(function(e){function t(e,r,i){var o={action:"getState"};chrome.tabs.sendMessage(e,o,function(o){void 0!==o||i?(s[r]=o,"play"===o&&u++,m++,m===f&&n()):chrome.tabs.executeScript(e,{file:l},function(){chrome.runtime.lastError?(log(chrome.runtime.lastError),n()):t(e,r,!0)})})}function n(){if(u){i();for(var t=0;t<f;t++)if("play"===s[t]){var n=e[t],l={action:"pause"};chrome.tabs.sendMessage(n.id,l),r(n.id,n.title)}sendRequest("youtube")}else c.length?(o(),sendRequest("youtube")):isBlocked()&&a(e)}for(var s=[],u=0,m=0,f=e.length,d=0;d<f;d++)t(e[d].id,d)})}function n(){e(function(e){for(var t={action:"skipAd"},n=0;n<e.length;n++)chrome.tabs.sendMessage(e[n].id,t)})}function r(e,t){t=t.substr(0,t.lastIndexOf(" - YouTube")),c.push(e),youtubeVideoNames.push(t)}function i(){c=[],youtubeVideoNames=[]}function o(){for(var e=0;e<c.length;e++)s(c[e]);i()}function a(e){for(var t=0;t<e.length;t++)if(e[t].active)return void s(e[t].id)}function s(e){var t={action:"play"};chrome.tabs.sendMessage(e,t)}function u(e){!c.ended&&c.length||(i(),r(e.id,e.title),sendRequest("youtube"),c.ended=!0,chrome.tabs.sendMessage(e.id,{action:"listen"},function(){c.ended&&c[0]===e.id&&i()}))}var c=[],l="/js/youtubeContent.js";addMessageListener({youtube:function(e){t(e.input)},youtubeEnd:function(e,t){u(t.tab)},skipAd:function(e,t){n(t.tab)}})}();var startTime=new Date,wastingTime=!1,url="",title="",timeLeft=0,timeLine=[],timeLineLength,isBlocked;!function(){function e(e){for(var i=new Date,o=r(i),a=0;a<e.length;a++)o<e[a][0][2]&&S.push([e[a][0][1],e[a][0][2]]);S.length&&(x=n(S[0][0]),t(x-i-B))}function t(e){S.length&&setTimer(function(){var e=x-new Date-timeLeft;if(e>0)t(e);else{var i=!0,o=new Date,a=r(o);a>S[0][1]?(S.splice(0,1),S.length?(x=n(S[0][0]),e=x-o-B):(x=1/0,i=!1)):e=n(S[0][1])-o,_(),i&&t(e)}},e)}function n(e){var t=new Date,n=Math.floor(e/60),r=e%60;return t.setHours(n),t.setMinutes(r),t.setSeconds(0),t.setMilliseconds(0),t}function r(e){return 60*e.getHours()+e.getMinutes()}function i(){chrome.tabs.query({active:!0},function(e){if(e.length){var t=e[0];y=t.id,w=t.windowId,o(t.url,t.title)}})}function o(e,t){var n=a(e),r=new Date-startTime;r<R&&(wastingTime=0);var i=[r,wastingTime,url,title,+startTime];s("add",i),wastingTime&&(u(-r),setTimeout(function(){storeData("timeLine",i)},0)),startTime=new Date,wastingTime=n,url=e,title=t,_();var o={newest:i,startTime:+startTime,wastingTime:wastingTime,url:url,title:title};O("newPage",o),startTime>C+R&&c()}function a(e){for(var t=0;t<j.length;t++)for(var n=0;n<j[t].length;n++)if(new RegExp("^"+j[t][n].replace(/\./g,"\\.").replace(/\*/g,".*")+"$").test(e))return t+1;return 0}function s(e,t){"add"===e?timeLine.unshift(t):"remove"===e?timeLine.splice(t[0],t[1]):"change"===e?t<timeLine.length||t<0?timeLine[t][1]&&(O("change",[t,timeLine[t][1]]),timeLine[t][1]=0,u(timeLine[t][0])):log("change to timeline out of bounds"+t+"/"+timeLine.length):log("timeLine action incorrect")}function u(e){timeLeft+=e}function c(){for(var e=new Date-timeLineLength,t=-1,n=0,r=0,i=new Date-startTime,o=wastingTime?i:0,a=timeLine.length-1;a!=-1;a--){var u=a?timeLine[a-1][4]:+timeLine[a][4]+timeLine[a][0];if(!(e>u)){r=timeLine[a][4]-e,t=a;break}timeLine[a][1]&&(timeLeft+=timeLine[a][0]),n++}t===-1&&(r=startTime-e),n&&s("remove",[t+1,n]);for(var l=!1,a=t;a!=-1;a--){if(timeLine[a][1]){if(!(timeLeft-o>r)){l=!0;break}s("change",a)}r+=timeLine[a][0]}l||(r+=i),_();var m=Math.min(r-timeLeft+o,timeLineLength-B);C=+new Date+m,clearTimer(L),L=setTimer(c,m)}function l(){startTime=new Date,timeLeft=B,timeLine=[],i();var e={timeLeft:timeLeft,startTime:+startTime,wastingTime:wastingTime,url:url,title:title};O("reset",e)}function m(){clearTimeout(A),M=0,b=y}function f(){m(),I=0,_()}function d(){M=startTime,f()}function h(){return M===startTime||(M=0,b=-1,!1)}function g(){m(),I=+new Date,A=setTimeout(function(){b=-1,I=0},Q),_()}function v(e){e===-1?wastingTime&&(O("change",[e,wastingTime]),wastingTime=0,o(url,title)):s("change",e),c(),_()}function p(){clearTimer(D),k=!0,_(),D=setTimer(function(){k=!1},q)}function T(){clearTimer(D),k=!1,_()}var L,y=-2,w=-3,b=-1,A=-1,I=0,M=0,k=!1,D=-1,C=0,S=[],x=1/0,j=[["*://reddit.com/*","*://*.reddit.com/*","http://threesjs.com/"],["*://*.youtube.com/*","*://imgur.com/*","*://*.imgur.com/*"]];timeLineLength=18e5;var B=3e5,E=3e5,Q=2e4,q=18e5,R=2e3,H=400;timeLeft=B;var F,N,O,U;addMessageListener({VIP:f,finish:d,resetTime:l,change:function(e){v(e.input)},temp:g,zero:p,antizero:T}),addScheduleListener(e),i(),chrome.tabs.onActivated.addListener(function(e){y=e.tabId,chrome.tabs.get(e.tabId,function(e){o(e.url,e.title)})}),chrome.tabs.onUpdated.addListener(function(e,t,n){y===e&&t&&("loading"===t.status?o(n.url,n.title):t.title&&(title=t.title))}),chrome.tabs.onReplaced.addListener(function(e,t){t===b&&(b=e)}),chrome.windows.onFocusChanged.addListener(function(e){e===chrome.windows.WINDOW_ID_NONE||(w!==e&&chrome.tabs.query({windowId:e,active:!0},function(e){if(e.length){var t=e[0];y=t.id,o(t.url,t.title)}else log("window empty tab")}),w=e)});var _=function(){function e(){O("timer",timeLeft);var e=timeLeft-(wastingTime?new Date-startTime:0),n=isBlocked()?a(U()):wastingTime,r=e+(2===n?E:0),i=0,o=wastingTime,s="time";b!==y||I||M&&!h()?r>x-new Date?(e=r=x-new Date,o=!0,s="class"):k&&(e=r=0):(e=r=1/0,o=!1);var u=Q-new Date+I;b===y&&r<u&&(!o&&!wastingTime&&r>i&&(i=r),e=r=u,o=!0),F(r,o,s),t(e,i,o)}function t(e,t,r){if(clearTimeout(o),clearInterval(i),e<0&&(e=0),n(e),r&&e>t){var a=(e-1)%1e3+1;o=setTimeout(function(){e-=a,r&&e>=t&&(n(e),i=setInterval(function(){e-=1e3,r&&e>=t?n(e):clearInterval(i)},1e3))},a)}}function n(e){chrome.browserAction.setBadgeText({text:r(e)})}function r(e){if(e===1/0)return"\u221e";var t=Math.ceil(e/1e3);return Math.floor(t/60)+":"+("0"+Math.floor(t%60)).slice(-2)}var i=-1,o=-1;return e}();!function(){function e(e,n,r){var i=+new Date,o=Math.max(n-R,H);a=setTimeout(function(){c(e,r,function(o){if(o){var a=+new Date-i;t(e,r,n-a)}})},o)}function t(e,t,c){if(e===y){var l={};"time"===t&&(l={timeLineLength:timeLineLength,iframeInfo:iframeInfo,delay:c});var m={action:"prepare",info:l,type:t};chrome.tabs.sendMessage(e,m),a=setTimeout(function(){e===y&&(s=e,u=!0,n=t,"time"===n&&(l={timeLeft:timeLeft,startTime:+startTime,wastingTime:wastingTime,url:url,title:title,timeLine:timeLine,timeLineLength:timeLineLength}),m={action:"block",info:l,type:t},chrome.tabs.sendMessage(e,m,function(t){t&&e===y&&(r=url,i=title,o("Blocked","Blocked"),storeData("redirect",[+new Date,url]))}))},c)}}var n,r,i,a=-1,s=-2,u=!1;F=function(t,n,r){(y!==s||t>0)&&N(),clearTimeout(a),n&&wastingTime&&(t<R&&(t=R),e(y,t,r))};var c=function(){function e(o,a,s){var u={action:"ping"};chrome.tabs.sendMessage(o,u,function(u){var c;if(u?u[a]||(c=[a]):c=["all",a],c&&c.length){for(var l=[],m=0;m<c.length;m++)l=l.concat(i[c[m]]);n?r.push(function(){e(o,a,s)}):(n=!0,t(o,l,0,function(e){if(n=!1,s(e),r.length){var t=r.shift();t()}}))}else s(!0)})}function t(e,n,r,i){var o=n[r],a=".js"===o.substring(o.lastIndexOf("."))?chrome.tabs.executeScript:chrome.tabs.insertCSS;a(e,{file:o},function(){return chrome.runtime.lastError?(console.log(chrome.runtime.lastError),void i(!1)):(r++,void(n.length===r?i(!0):t(e,n,r,i)))})}var n=!1,r=[],i={all:["/lib/jquery.min.js","/css/content.css","/js/content.js"],schedule:["/lib/jquery-ui.min.js","/lib/jquery-ui.min.css","/css/schedule.css","/js/schedule.js"],time:["/js/timeLine.js","/js/keyPress.js","/js/iframe.js","/css/timeLine.css"]};return e}();N=function(){s!==-2&&(O("unblock",null,!0),s=-2,u=!1,isBlocked()&&o(r,i))},O=function(e,t,n){n||sendRequest(e,t),s!==-2&&chrome.tabs.sendMessage(s,sendFormat(e,t))},isBlocked=function(){return"Blocked"===url},U=function(){return r}}()}(),chrome.commands.onCommand.addListener(function(e){switch(e){case"open_schedule":window.open(chrome.extension.getURL("/html/schedule.html"));break;case"open_options":window.open(chrome.extension.getURL("/html/options.html"))}});