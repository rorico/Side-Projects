function setSleepAlarm(){var e=new Date;e.setSeconds(0),e.setMinutes(30*Math.floor(e.getMinutes()/30)+30),e.getHours()<sleepAlarmStart&&e.getHours()>sleepAlarmEnd&&(e.setHours(sleepAlarmStart),e.setMinutes(0)),chrome.alarms.create("sleep",{when:+e})}function setAlarm(e,t){for(var r=0;r<alarms.length;r++)if(!alarms[r][0]){var n=new Date;n.setMinutes(n.getMinutes()+e),++alarmCnt;var a=setTimeout(function(){ringAlarm(r,t)},6e4*e);return alarms[r]=[1,n,a,t],sendRequest("setAlarm",[r,+n,t]),[r,+n]}return[-1,0]}function ringAlarm(e,t){t>ringingTypeMax&&(chrome.browserAction.setBadgeBackgroundColor({color:typeColors[t]}),ringingTypeMax=t),ringingTypeCnt[t]++,ringingCnt++,alarms[e][0]=2,playAlarmCheck[0]=!0,sendRequest("ringing",e);var r=setInterval(function(){playAlarmCheck[0]?audio.play():clearInterval(r)},3e3)}function removeAlarm(e,t){if(alarms[e][0]&&(void 0===t&&2!==alarms[e][3]||alarms[e][3]==t)){if(--alarmCnt,playAlarmCheck[0]&&2===alarms[e][0])if(ringingTypeCnt[t]--,0===--ringingCnt)ringingTypeMax=-1,playAlarmCheck[0]=!1,audio.pause(),audio.currentTime=0,chrome.browserAction.setBadgeBackgroundColor({color:defaultColor});else for(var r=ringingTypeMax;r>=0;r--)if(ringingTypeCnt[r]){ringingTypeMax=r,chrome.browserAction.setBadgeBackgroundColor({color:typeColors[r]});break}return clearTimeout(alarms[e][2]),alarms[e][0]=0,sendRequest("removeAlarm",[e,alarms[e][3]]),!0}return!1}function stopAllAlarms(e){var t=!1;if(playAlarmCheck[0])for(var r=0;r<alarms.length;r++)2===alarms[r][0]&&(t|=removeAlarm(r,e));return t}function snooze(){stopAllAlarms()&&setAlarm(5,0)}function sendRequest(e,t){chrome.runtime.sendMessage({from:"background",action:e,input:t})}function setScheduleInfo(){chrome.storage.sync.get("scheduleInfo",function(e){e.scheduleInfo?(scheduleInfo=e.scheduleInfo,today=todaySchedule(date)):(scheduleInfo=[],today=[])})}function todaySchedule(e){for(var t=[],r=0;r<scheduleInfo.length;r++)for(var n=0;n<scheduleInfo[r][1].length;n++)for(var a=0;a<scheduleInfo[r][1][n][1].length;a++){var i=scheduleInfo[r][1][n][1][a];sameDOW(e,i[0][0])&&isInRange(e,i[2])&&t.push([i[0],i[1],scheduleInfo[r][0],scheduleInfo[r][1][n][0]])}return t.sort(sort_by_date),t}function sameDOW(e,t){var r=new Date(e).getDay(),n=-1;switch(r){case 1:n="M";break;case 2:n="T";break;case 3:n="W";break;case 4:n="Th";break;case 5:n="F"}return t.indexOf(n)>-1?"T"==n&&"h"==t[t.indexOf(n)+1]?!1:!0:!1}function isInRange(e,t){return e>=t[0]&&e<=t[1]}function sort_by_date(e,t){return e[0][1]<t[0][1]?-1:e[0][1]>t[0][1]?1:0}function siteBlocked(){var e=wastingTime?new Date-startTime:0;if(e>=timeLeft)return!0;for(var t=new Date,r=100*t.getHours()+t.getMinutes()/.6,n=0;n<today.length&&today[n][0][1]<=r;n++)if(today[n][0][2]>r)return!0;return!1}function storeRedirect(e){chrome.storage.sync.get("redirects",function(t){var r=t.redirects;r||(r=[]);var n=[+new Date,e],a=8e3;JSON.stringify(n).length>a?(console.log("can't store the following, too large:"),console.log(n)):JSON.stringify(r).length+JSON.stringify(n).length>a?moveRedirect(r,e):(r.push(n),chrome.storage.sync.set({redirects:r}))})}function moveRedirect(e,t){chrome.storage.sync.get("redirectIndexes",function(r){var n=r.redirectIndexes;n||(n=[]);var a="redirect_"+n.length;n.push(a);var i={redirectIndexes:n,redirects:[]};i[a]=e,chrome.storage.sync.set(i),storeRedirect(t)})}function startTimeLine(){chrome.tabs.getSelected(chrome.windows.WINDOW_ID_CURRENT,function(e){handleNewPage(matchesURL(e.url),e.url,e.title)}),returnTime(timeLineLength-timeLeft)}function handleTimeLineAsync(e,t){for(;!timeLineAsync;)console.log("didn't think this situation would ever happen, good thing I coded this");timeLineAsync=!1,"add"===e?timeLine.unshift(t):"remove"===e?timeLine.splice(t[0],t[1]):"change"===e?-1===t?(sendRequest("change",[t,wastingTime]),wastingTime=0):t<timeLine.length?(sendRequest("change",[t,timeLine[t][1]]),timeLine[t][1]&&(timeLine[t][1]=0,changeTimeLeft(timeLine[t][0]))):console.log("change to timeline out of bounds"+t+"/"+timeLine.length):console.log("this shouldn't happen"),timeLineAsync=!0}function handleNewPage(e,t,r){stopAllAlarms(2);var n=new Date-startTime;handleTimeLineAsync("add",[n,wastingTime,url,title,startTime]),wastingTime&&(changeTimeLeft(-n),1===wastingTime&&clearTimeout(alarm)),startTime=new Date,wastingTime=e,url=t,title=r,e&&1===e&&tabId!==VIPtab&&setReminder(timeLeft),badgeDisplay()}function changeTimeLeft(e){timeLeft+=e}function badgeDisplay(){sendRequest("timer",timeLeft),VIPtab===tabId?tempVIPstartTime?siteBlocked||timeLeft-(wastingTime?new Date-startTime:0)<VIPlength?countDownTimer(VIPlength-new Date+tempVIPstartTime,!0):displayTimeLeft():chrome.browserAction.setBadgeText({text:"\u221e"}):displayTimeLeft()}function displayTimeLeft(){var e=wastingTime?new Date-startTime:0,t=timeLeft-e;countDownTimer(t,wastingTime)}function countDownTimer(e,t){if(clearTimeout(displayTimeStarter),clearInterval(displayTimer),0>e&&(e=0),setBadgeText(e),t&&e>0){var r=(e-1)%1e3+1;displayTimeStarter=setTimeout(function(){e-=r,t&&e>=0&&(setBadgeText(e),displayTimer=setInterval(function(){e-=1e3,t&&e>=0?setBadgeText(e):clearInterval(displayTimer)},1e3))},r)}}function setBadgeText(e){chrome.browserAction.setBadgeText({text:MinutesSecondsFormat(e)})}function MinutesSecondsFormat(e){var t=Math.ceil(e/1e3);return Math.floor(t/60)+":"+("0"+Math.floor(t%60)).slice(-2)}function returnTime(e){returnTimer=setTimeout(function(){for(var e=new Date-timeLineLength,t=0,r=0,n=0,a=new Date-startTime,i=wastingTime?a:0,s=timeLine.length-1;-1!=s;s--){var o=s?timeLine[s-1][4]:+timeLine[s][4]+timeLine[s][0];if(o>=e){n=timeLine[s][4]-e,t=s+1;break}timeLine[s][1]&&(timeLeft+=timeLine[s][0]),r++}r&&handleTimeLineAsync("remove",[t,r]);for(var l=[],m=!1,s=timeLine.length-1;-1!=s;s--){if(timeLine[s][1]){if(n>=timeLeft-i){m=!0;break}l.push([s,timeLine[s][1],timeLine[s][0]]),handleTimeLineAsync("change",s)}n+=timeLine[s][0]}m||(n+=a),badgeDisplay(),returnTime(n-timeLeft+i)},e)}function matchesURL(e){for(var t=0;t<urls.length;t++)for(var r=0;r<urls[t].length;r++)if(RegExp("^"+urls[t][r].replace(/\./g,"\\.").replace(/\*/g,".*")+"$").test(e))return t+1;return 0}function setReminder(e){clearTimeout(alarm);var t=timeLeft;timeLeft>0||(e=2e3),alarm=setTimeout(function(){timeLeft===t?setAlarm(0,2):setReminder(t-timeLeft)},e)}function clearAlarm(){clearTimeout(alarm),stopAllAlarms(2)}function resetTime(){clearTimeout(returnTimer),startTime=new Date,timeLeft=startingTimeLeft,timeLine=[],startTimeLine(),sendRequest("reset")}function makeCurrentTabVIP(){clearTimeout(tempVIPtimer),VIPtab=tabId,clearAlarm()}function VIP(){makeCurrentTabVIP(),tempVIPstartTime=0,badgeDisplay()}function tempVIP(){makeCurrentTabVIP(),tempVIPstartTime=+new Date,tempVIPtimer=setTimeout(function(){VIPtab=-1,tempVIPstartTime=0,wastingTime&&setReminder(timeLeft)},VIPlength),badgeDisplay()}function change(e){handleTimeLineAsync("change",e),0>timeLeft||clearAlarm(),clearTimeout(returnTimer),returnTime(),badgeDisplay()}function sendRequest(e,t){chrome.runtime.sendMessage({from:"background",action:e,input:t})}var sleepAlarmStart=22,sleepAlarmEnd=6;setSleepAlarm(),chrome.alarms.onAlarm.addListener(function(e){"sleep"==e.name&&(setAlarm(0,1),setSleepAlarm())});var alarms=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],typeColors=["#0000FF","#33FFFF","#FF0000"],defaultColor="#000000",alarmCnt=0,ringingCnt=0,ringingTypeCnt=[0,0,0],ringingTypeMax=-1,audio=new Audio("/alarm.mp3"),playAlarmCheck=[!1];chrome.browserAction.setBadgeBackgroundColor({color:defaultColor}),chrome.browserAction.setBadgeText({text:""}),chrome.runtime.onMessage.addListener(function(e){if("browserAction"===e.from)switch(e.action){case"VIP":VIP();break;case"resetTime":resetTime();break;case"change":change(e.input);break;case"temp":tempVIP();break;case"stopAllAlarms":stopAllAlarms();break;case"snooze":snooze();break;case"setAlarm":setAlarm(e.input,0);break;case"removeAlarm":removeAlarm(e.input)}else if("options"===e.from)switch(e.action){case"resetSchedule":setScheduleInfo()}});var scheduleInfo,date=new Date,today;setScheduleInfo(),chrome.commands.onCommand.addListener(function(e){switch(e){case"open_schedule":window.open(chrome.extension.getURL("/html/schedule.html"));break;case"open_options":window.open(chrome.extension.getURL("/html/options.html"))}});var startTime=new Date,wastingTime=!1,url="",title="",tabId=-1,timeLineLength=18e5,startingTimeLeft=3e5,VIPlength=2e4,timeLeft=startingTimeLeft,alarm,timeLine=[],timeLineAsync=!0,returnTimer=-1,displayTimer=-1,displayTimeStarter=-1,VIPtab=-1,tempVIPtimer=-1,tempVIPstartTime=0,urls=[["http://reddit.com/*","https://reddit.com/*","http://*.reddit.com/*","https://*.reddit.com/*","http://threesjs.com/"],["http://*.youtube.com/*","https://*.youtube.com/*","http://imgur.com/*","https://imgur.com/*","http://*.imgur.com/*","https://*.imgur.com/*"]];startTimeLine(),chrome.webRequest.onBeforeRequest.addListener(function(e){function t(e){return setTimeout(function(){storeRedirect(e.url)},0),{redirectUrl:chrome.extension.getURL("/html/schedule.html")}}return e.tabId!=VIPtab&&siteBlocked()?t(e):void 0},{urls:urls[0],types:["main_frame"]},["blocking"]),chrome.tabs.onActivated.addListener(function(e){this.tabId=e.tabId,chrome.tabs.get(e.tabId,function(e){handleNewPage(matchesURL(e.url),e.url,e.title)})}),chrome.tabs.onUpdated.addListener(function(e,t,r){t&&"loading"===t.status&&e==this.tabId?handleNewPage(matchesURL(r.url),r.url,r.title):t&&t.title&&e==this.tabId&&(title=t.title)});