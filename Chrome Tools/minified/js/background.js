function log(e){addLog(JSON.stringify(e)),console.log(e)}function addLog(e){allLogs.push([e,!1]),numUnread++}function removeLog(e){allLogs[e][1]||(allLogs[e][1]=!0,numUnread--)}function setTimer(e,t){if(!t||t<timerThreshold)return timerHandlers[++curTimerId]=[0,setTimeout(e,t)],curTimerId;for(var n=0,r=+new Date+t,i=0;i<timerQueue.length&&!(r<timerQueue[i][1]);i++)n++;return timerQueue.splice(n,0,[++curTimerId,r,e]),n||(chrome.alarms.clearAll(),chrome.alarms.create("timer",{when:r})),timerHandlers[curTimerId]=[1],curTimerId}function clearTimer(e){var t=timerHandlers[e];if(t)if(t[0]){for(var n=0;n<timerQueue.length;n++)if(e===timerQueue[n][0]){timerQueue.splice(n,1),0===n&&(chrome.alarms.clearAll(),chrome.alarms.create("timer",{when:timerQueue[0][1]}));break}}else clearTimeout(t[1])}function setSleepAlarm(){var e=new Date;e.setSeconds(0),e.setMinutes(30*Math.floor(e.getMinutes()/30)+30),e.getHours()<sleepAlarmStart&&e.getHours()>sleepAlarmEnd&&(e.setHours(sleepAlarmStart),e.setMinutes(0)),setTimer(function(){setAlarm(0,1),setSleepAlarm()},e-new Date)}function setAlarm(e,t){for(var n=0;n<numMaxAlarms;n++){var r=alarms[n];if(!r){var i=new Date;i.setMinutes(i.getMinutes()+e);var a=setRing(n,t,e);alarmCnt++,alarmTypeCnt[t]++,t>alarmTypeMax&&(chrome.browserAction.setBadgeBackgroundColor({color:typeColors[t]}),alarmTypeMax=t);var o={state:1,alarmTime:i,type:t,destructor:a};return alarms[n]=o,void sendRequest("setAlarm",[n,+i,t])}}}function setRing(e,t,n){var r,i=setTimer(function(){ringingCnt++,alarms[e].state=2,playAlarmCheck=!0,sendRequest("ringing",e),chrome.windows.getAll(function(n){n.length&&(audio.play(),1===t&&(r=setTimeout(function(){removeAlarm(e,t),setAlarm(5,1)},5e3)))})},6e4*n);return function(){clearTimer(i),clearTimeout(r)}}function removeAlarm(e,t){var n=alarms[e];if(n&&("undefined"==typeof t&&2!==n.type||n.type==t)){if(alarmTypeCnt[t]--,--alarmCnt){for(var r=alarmTypeMax;r>=0;r--)if(alarmTypeCnt[r]){alarmTypeMax=r,chrome.browserAction.setBadgeBackgroundColor({color:typeColors[r]});break}}else alarmTypeMax=-1,chrome.browserAction.setBadgeBackgroundColor({color:defaultColor});return playAlarmCheck&&2===n.state&&(--ringingCnt||(playAlarmCheck=!1,audio.pause(),audio.currentTime=0)),n.destructor(),alarms[e]=void 0,sendRequest("removeAlarm",[e,n.type]),!0}return!1}function stopAllAlarms(e){var t=!1;if(playAlarmCheck)for(var n=0;n<alarms.length;n++)alarms[n]&&2===alarms[n].state&&(t|=removeAlarm(n,e));return t}function snooze(){stopAllAlarms()&&setAlarm(5,0)}function setScheduleInfo(){chrome.storage.sync.get("scheduleInfo",function(e){chrome.runtime.lastError&&log(chrome.runtime.lastError),e.scheduleInfo?(scheduleInfo=e.scheduleInfo,today=todaySchedule(date),setupClass()):(scheduleInfo=[],today=[])})}function weekSchedule(e){for(var t=[],n=0;n<e.length;n++)t.push(todaySchedule(e[n]));return t}function sendRequest(e,t,n){var r={from:"background",action:e,input:t};chrome.runtime.sendMessage(r),n&&sendContent(r)}var allLogs=[],numUnread=0;window.onerror=function(e,t,n,r,i){addLog(e)};var storeData,getData;!function(){function e(e,a,u){var l=e+s,m=e+c;r([l,m],function(s){var c=s[l]||[],f=s[m]||{},d=function(){var n=e+"_"+c.length;c.push(n);var r={indexes:c};r[l]=c,r[e+o]=[],r[n]=a,r[m]=f,t(r),storeData(e,u)};f.sync||(f.sync=[0,c.length]),f.sync[1]++;var h=f.sync[1]-f.sync[0]-3;if(h>0){f.local||(f.local=[0,0]),f.local[1]+=h;var g=c.slice(f.sync[0],f.sync[0]+h);f.sync[0]+=h,r(g,function(e){n(e),i(g,d)})}else d()})}function t(e,t,n){chrome.storage.sync.set(e,function(){a(n)||"function"!=typeof t||t()})}function n(e,t,n){chrome.storage.local.set(e,function(){a(n)||"function"!=typeof t||t()})}function r(e,t,n){chrome.storage.sync.get(e,function(e){a(n)||"function"!=typeof t||t(e)})}function i(e,t,n){chrome.storage.sync.remove(e,function(){a(n)||"function"!=typeof t||t()})}function a(e){return!!chrome.runtime.lastError&&("function"==typeof e&&e(chrome.runtime.lastError.message),log(chrome.runtime.lastError.message),!0)}var o="s",s="Indexes",c="Meta";storeData=function(n,i){var a=n+o;r(a,function(r){var o=r[a]||[],s=7e3;if(JSON.stringify(i).length>s)log("can't store the following, too large:"),log(i);else if(JSON.stringify(o).length+JSON.stringify(i).length>s)e(n,o,i);else{o.push(i);var c={};c[a]=o,t(c,null,function(t){"QUOTA_BYTES quota exceeded"===t&&e(n,o,i)})}})},getData=function(e,t){var n=e+s,i=e+c;r([n,i],function(a){var s=a[n]||[],c=a[i]||{};c.sync&&(s=s.slice(c.sync[0],c.sync[1])),s.push(e+o),r(s,t)})}}();var timerThreshold=3e5,timerQueue=[],curTimerId=0,timerHandlers=[];chrome.alarms.onAlarm.addListener(function(e){if("timer"===e.name){for(var t=+new Date+timerThreshold,n=0,r=0;r<timerQueue.length&&timerQueue[r][1]<t;r++)timerHandlers[timerQueue[r][0]]=setTimeout(timerQueue[r][2],timerQueue[r][1]-new Date),n++;timerQueue.splice(0,n),timerQueue.length&&chrome.alarms.create("timer",{when:timerQueue[0][1]})}});var alarms=[],numMaxAlarms=3,typeColors=["#0000FF","#33FFFF","#FF0000"],defaultColor="#000000",alarmCnt=0,ringingCnt=0,alarmTypeCnt=[0,0,0],alarmTypeMax=-1,audio=new Audio("/alarm.mp3");audio.loop=!0;var playAlarmCheck=!1;chrome.browserAction.setBadgeBackgroundColor({color:defaultColor});var sleepAlarmStart=22,sleepAlarmEnd=6;setSleepAlarm();var startTime=new Date,wastingTime=!1,url="",title="",timeLeft=0,timeLine=[],timeLineLength,change,VIP,resetTime,tempVIP,zero,antizero,setupClass,sendContent;!function(){function e(r){w.length&&setTimer(function(){var r=y-new Date-timeLeft;if(r>0)e(r);else{var i=!0,a=new Date,o=n(a);o>w[0][1]?(w.splice(0,1),w.length?(y=t(w[0][0]),r=y-a-b):(y=1/0,i=!1)):r=t(w[0][1])-a,S(),i&&e(r)}},r)}function t(e){var t=new Date,n=Math.floor(e/60),r=e%60;return t.setHours(n),t.setMinutes(r),t.setSeconds(0),t.setMilliseconds(0),t}function n(e){return 60*e.getHours()+e.getMinutes()}function r(){chrome.tabs.query({windowId:chrome.windows.WINDOW_ID_CURRENT,active:!0},function(e){if(e.length){var t=e[0];i(t.url,t.title),f=t.id}}),c(timeLineLength-timeLeft)}function i(e,t){var n=a(e),r=new Date-startTime;r<D&&(wastingTime=0);var i=[r,wastingTime,url,title,+startTime];o("add",i),wastingTime&&(s(-r),setTimeout(function(){storeData("timeLine",i)},0)),startTime=new Date,wastingTime=n,url=e,title=t,S();var u={newest:i,startTime:+startTime,wastingTime:wastingTime,url:url,title:title};sendRequest("newPage",u,1),startTime>m+D&&(log("you probably slept the computer, didn't you?"),clearTimer(l),c())}function a(e){for(var t=0;t<L.length;t++)for(var n=0;n<L[t].length;n++)if(new RegExp("^"+L[t][n].replace(/\./g,"\\.").replace(/\*/g,".*")+"$").test(e))return t+1;return 0}function o(e,t){"add"===e?timeLine.unshift(t):"remove"===e?timeLine.splice(t[0],t[1]):"change"===e?t<timeLine.length||t<0?timeLine[t][1]&&(sendRequest("change",[t,timeLine[t][1]],1),timeLine[t][1]=0,s(timeLine[t][0])):log("change to timeline out of bounds"+t+"/"+timeLine.length):log("timeLine action incorrect")}function s(e){timeLeft+=e}function c(e){l=setTimer(function(){for(var e=new Date-timeLineLength,t=-1,n=0,r=0,i=new Date-startTime,a=wastingTime?i:0,s=timeLine.length-1;s!=-1;s--){var u=s?timeLine[s-1][4]:+timeLine[s][4]+timeLine[s][0];if(!(e>u)){r=timeLine[s][4]-e,t=s;break}timeLine[s][1]&&(timeLeft+=timeLine[s][0]),n++}t===-1&&(r=startTime-e),n&&o("remove",[t+1,n]);for(var l=!1,s=t;s!=-1;s--){if(timeLine[s][1]){if(!(timeLeft-a>r)){l=!0;break}o("change",s)}r+=timeLine[s][0]}l||(r+=i),S();var f=Math.min(r-timeLeft+a,timeLineLength-b);m=new Date+f,c(f)},e)}function u(){clearTimeout(g),h=f}var l,m,f=-2,d=-3,h=-1,g=-1,v=0,T=!1,p=-1,w=[],y=1/0,L=[["*://reddit.com/*","*://*.reddit.com/*","http://threesjs.com/"],["*://*.youtube.com/*","*://imgur.com/*","*://*.imgur.com/*"]];timeLineLength=18e5;var b=3e5,A=3e5,I=2e4,k=18e5,D=2e3;timeLeft=b;var C,M;r(),setupClass=function(){for(var r=new Date,i=n(r),a=0;a<today.length;a++)i<today[a][0][2]&&w.push([today[a][0][1],today[a][0][2]]);w.length&&(y=t(w[0][0]),e(y-r-b))},chrome.tabs.onActivated.addListener(function(e){f=e.tabId,chrome.tabs.get(e.tabId,function(e){i(e.url,e.title)})}),chrome.tabs.onUpdated.addListener(function(e,t,n){f===e&&t&&("loading"===t.status?i(n.url,n.title):t.title&&(title=t.title))}),chrome.tabs.onReplaced.addListener(function(e,t){t===h&&(h=e)}),chrome.windows.onFocusChanged.addListener(function(e){e===chrome.windows.WINDOW_ID_NONE||(d!==e&&chrome.tabs.query({windowId:e,active:!0},function(e){if(e.length){var t=e[0];i(t.url,t.title),f=t.id}else log("window empty tab")}),d=e)});var S=function(){function e(){var e=timeLeft-(wastingTime?new Date-startTime:0),n=e+(2===wastingTime?A:0),r=0,i=wastingTime,a="time";h!==f||v?n>y-new Date?(e=n=y-new Date,i=!0,a="class"):T&&(e=n=0):(e=n=1/0,i=!1);var o=I-new Date+v;h===f&&n<o&&(!i&&!wastingTime&&n>r&&(r=n),e=n=o,i=!0),C(n,i,a),t(e,r,i)}function t(e,t,r){if(clearTimeout(a),clearInterval(i),e<0&&(e=0),n(e),r&&e>t){var o=(e-1)%1e3+1;a=setTimeout(function(){e-=o,r&&e>=t&&(n(e),i=setInterval(function(){e-=1e3,r&&e>=t?n(e):clearInterval(i)},1e3))},o)}}function n(e){chrome.browserAction.setBadgeText({text:r(e)})}function r(e){if(e===1/0)return"\u221e";var t=Math.ceil(e/1e3);return Math.floor(t/60)+":"+("0"+Math.floor(t%60)).slice(-2)}var i=-1,a=-1;return e}();!function(){function e(e,n,r){var i=+new Date;o=setTimeout(function(){u(e,r,function(){var a=+new Date-i;o=setTimeout(function(){t(e,r)},n-a)})},n-D)}function t(e,t){if(e===f){s=e,c=!0,n=t;var o;"time"===n&&(o={timeLeft:timeLeft,startTime:+startTime,wastingTime:wastingTime,url:url,title:title,timeLine:timeLine,timeLineLength:timeLineLength}),storeData("redirect",[+new Date,url]);var u={action:"block",info:o,type:t};chrome.tabs.sendMessage(e,u,function(t){t&&e===f&&(r=url,a=title,i("Blocked","Blocked"))})}}var n,r,a,o=-1,s=-2,c=!1;C=function(t,n,r){(f!==s||t>0)&&M(),clearTimeout(o),n&&wastingTime&&(t<D&&(t=D),e(f,t,r))};var u=function(){function e(e,r,i){var a={action:"ping"};chrome.tabs.sendMessage(e,a,function(a){var o;if(a?a[r]||(o=[r]):o=["all",r],o&&o.length){for(var s=[],c=0;c<o.length;c++)s=s.concat(n[o[c]]);t(e,s,0,i)}else i()})}function t(e,n,r,i){var a=n[r],o=".js"===a.substring(a.lastIndexOf("."))?chrome.tabs.executeScript:chrome.tabs.insertCSS;o(e,{file:a},function(){return chrome.runtime.lastError?void console.log(chrome.runtime.lastError):(r++,void(n.length===r?i():t(e,n,r,i)))})}var n={all:["/lib/jquery.min.js","/css/content.css","/js/content.js"],schedule:["/lib/jquery-ui.min.js","/lib/jquery-ui.min.css","/css/schedule.css","/js/schedule.js"],time:["/js/timeLine.js","/js/keyPress.js","/css/timeLine.css"]};return e}();M=function(){s!==-2&&(sendContent({action:"unblock"}),s=-2,c=!1,"Blocked"===url&&i(r,a))},sendContent=function(e){s!==-2&&chrome.tabs.sendMessage(s,e)}}(),resetTime=function(){clearTimer(l),startTime=new Date,timeLeft=b,timeLine=[],r();var e={timeLeft:timeLeft,startTime:+startTime,wastingTime:wastingTime,url:url,title:title};sendRequest("reset",e,1)},VIP=function(){u(),v=0,S()},tempVIP=function(){u(),v=+new Date,g=setTimeout(function(){h=-1,v=0},I),S()},change=function(e){e===-1?wastingTime&&(sendRequest("change",[e,wastingTime],1),wastingTime=0,i(url,title)):o("change",e),clearTimer(l),c(),S()},zero=function(){clearTimer(p),T=!0,S(),p=setTimer(function(){T=!1},k)},antizero=function(){clearTimer(p),T=!1,S()}}();var scheduleInfo,date=new Date,today;setScheduleInfo();var todaySchedule=function(){function e(e){for(var i=[],a=0;a<scheduleInfo.length;a++)for(var o=0;o<scheduleInfo[a][1].length;o++)for(var s=0;s<scheduleInfo[a][1][o][1].length;s++){var c=scheduleInfo[a][1][o][1][s];t(e,c[0][0])&&n(e,c[2])&&i.push([c[0],c[1],scheduleInfo[a][0],scheduleInfo[a][1][o][0]])}return i.sort(r),i}function t(e,t){var n=new Date(e).getDay(),r=-1;switch(n){case 1:r="M";break;case 2:r="T";break;case 3:r="W";break;case 4:r="Th";break;case 5:r="F"}return t.indexOf(r)>-1&&("T"!=r||"h"!=t[t.indexOf(r)+1])}function n(e,t){return e>=t[0]&&e<=t[1]}function r(e,t){return e[0][1]<t[0][1]?-1:e[0][1]>t[0][1]?1:0}return e}(),youtube=function(){function e(){chrome.tabs.query({url:["*://*.youtube.com/*","*://youtube.com/*"],active:!1},function(e){for(var r=0,i=e.length,a=!1,o=0;o<i;o++){var s=e[o],c={action:"pause"},u=function(e){return function(o){o&&(a?n.push(e):n=[e],a=!0),r++,r!==i||a||t()}}(s.id);chrome.tabs.sendMessage(s.id,c,u)}})}function t(){for(var e=0;e<n.length;e++){var t={action:"play"};chrome.tabs.sendMessage(n[e],t)}n=[]}var n=[];return e}();chrome.commands.onCommand.addListener(function(e){switch(e){case"open_schedule":window.open(chrome.extension.getURL("/html/schedule.html"));break;case"open_options":window.open(chrome.extension.getURL("/html/options.html"))}}),chrome.runtime.onMessage.addListener(function(e,t,n){if("browserAction"===e.from)switch(e.action){case"VIP":VIP();break;case"resetTime":resetTime();break;case"change":change(e.input);break;case"temp":tempVIP();break;case"zero":zero();break;case"antizero":antizero();break;case"stopAllAlarms":stopAllAlarms();break;case"snooze":snooze();break;case"setAlarm":setAlarm(e.input,0);break;case"removeAlarm":removeAlarm(e.input);break;case"removeLog":removeLog(e.input);break;case"youtube":youtube()}else if("options"===e.from)switch(e.action){case"resetSchedule":setScheduleInfo()}else if("content"===e.from)switch(e.action){case"weekSchedule":n(weekSchedule(e.input))}});