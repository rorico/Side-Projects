function log(e){addLog(JSON.stringify(e)),console.log(e)}function addLog(e){allLogs.push([e,!1]),numUnread++}function removeLog(e){allLogs[e][1]||(allLogs[e][1]=!0,numUnread--)}function setTimer(e,t){if(!t||t<timerThreshold)return timerHandlers[++curTimerId]=[0,setTimeout(e,t)],curTimerId;for(var r=0,n=+new Date+t,a=0;a<timerQueue.length&&!(n<timerQueue[a][1]);a++)r++;return timerQueue.splice(r,0,[++curTimerId,n,e]),r||(chrome.alarms.clearAll(),chrome.alarms.create("timer",{when:n})),timerHandlers[curTimerId]=[1],curTimerId}function clearTimer(e){var t=timerHandlers[e];if(t)if(t[0]){for(var r=0;r<timerQueue.length;r++)if(e===timerQueue[r][0]){timerQueue.splice(r,1),0===r&&(chrome.alarms.clearAll(),chrome.alarms.create("timer",{when:timerQueue[0][1]}));break}}else clearTimeout(t[1])}function setSleepAlarm(){var e=new Date;e.setSeconds(0),e.setMinutes(30*Math.floor(e.getMinutes()/30)+30),e.getHours()<sleepAlarmStart&&e.getHours()>sleepAlarmEnd&&(e.setHours(sleepAlarmStart),e.setMinutes(0)),setTimer(function(){setAlarm(0,1),setSleepAlarm()},e-new Date)}function setAlarm(e,t){for(var r=0;r<alarms.length;r++)if(!alarms[r][0]){var n=new Date;n.setMinutes(n.getMinutes()+e),alarmCnt++;var a=setTimer(function(){ringAlarm(r,t)},6e4*e);return alarmTypeCnt[t]++,t>alarmTypeMax&&(chrome.browserAction.setBadgeBackgroundColor({color:typeColors[t]}),alarmTypeMax=t),alarms[r]=[1,n,a,t],sendRequest("setAlarm",[r,+n,t]),[r,+n]}return[-1,0]}function ringAlarm(e,t){if(ringingCnt++,alarms[e][0]=2,playAlarmCheck=!0,sendRequest("ringing",e),audio.play(),1===t){var r=alarms[e][1];setInterval(function(){r===alarms[e][1]&&2===alarms[e][0]&&(removeAlarm(e,t),setAlarm(5,1))},5e3)}}function removeAlarm(e,t){if(alarms[e][0]&&("undefined"==typeof t&&2!==alarms[e][3]||alarms[e][3]==t)){if(alarmTypeCnt[t]--,--alarmCnt){for(var r=alarmTypeMax;r>=0;r--)if(alarmTypeCnt[r]){alarmTypeMax=r,chrome.browserAction.setBadgeBackgroundColor({color:typeColors[r]});break}}else alarmTypeMax=-1,chrome.browserAction.setBadgeBackgroundColor({color:defaultColor});return playAlarmCheck&&2===alarms[e][0]&&(--ringingCnt||(playAlarmCheck=!1,audio.pause(),audio.currentTime=0)),clearTimer(alarms[e][2]),alarms[e][0]=0,sendRequest("removeAlarm",[e,alarms[e][3]]),!0}return!1}function stopAllAlarms(e){var t=!1;if(playAlarmCheck)for(var r=0;r<alarms.length;r++)2===alarms[r][0]&&(t|=removeAlarm(r,e));return t}function snooze(){stopAllAlarms()&&setAlarm(5,0)}function sendRequest(e,t){chrome.runtime.sendMessage({from:"background",action:e,input:t})}function setScheduleInfo(){chrome.storage.sync.get("scheduleInfo",function(e){e.scheduleInfo?(scheduleInfo=e.scheduleInfo,today=todaySchedule(date),setupClass()):(scheduleInfo=[],today=[])})}var allLogs=[],numUnread=0;window.onerror=function(e,t,r,n,a){addLog(e)};var timerThreshold=3e5,timerQueue=[],curTimerId=0,timerHandlers=[];chrome.alarms.onAlarm.addListener(function(e){if("timer"===e.name){for(var t=+new Date+timerThreshold,r=0,n=0;n<timerQueue.length&&timerQueue[n][1]<t;n++)timerHandlers[timerQueue[n][0]]=setTimeout(timerQueue[n][2],timerQueue[n][1]-new Date),r++;timerQueue.splice(0,r),timerQueue.length&&chrome.alarms.create("timer",{when:timerQueue[0][1]})}});var alarms=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],typeColors=["#0000FF","#33FFFF","#FF0000"],defaultColor="#000000",alarmCnt=0,ringingCnt=0,alarmTypeCnt=[0,0,0],alarmTypeMax=-1,audio=new Audio("/alarm.mp3");audio.loop=!0;var playAlarmCheck=!1;chrome.browserAction.setBadgeBackgroundColor({color:defaultColor});var sleepAlarmStart=22,sleepAlarmEnd=6;setSleepAlarm();var startTime=new Date,wastingTime=!1,url="",title="",timeLeft=0,timeLine=[],timeLineLength,change,VIP,resetTime,tempVIP,setupClass;!function(){function e(n){w.length&&setTimer(function(){var n=v-new Date-timeLeft;if(n>0)e(n);else{var a=!0,i=new Date,o=r(i);o>w[0][1]?(w.splice(0,1),w.length?(v=t(w[0][0]),n=v-i-L):(v=1/0,a=!1)):n=t(w[0][1])-i,C(),a&&e(n)}},n)}function t(e){var t=new Date,r=Math.floor(e/100),n=e%100*.6;return t.setHours(r),t.setMinutes(n),t.setSeconds(0),t.setMilliseconds(0),t}function r(e){return 100*e.getHours()+e.getMinutes()/.6}function n(){chrome.tabs.query({windowId:chrome.windows.WINDOW_ID_CURRENT,active:!0},function(e){if(e.length){var t=e[0];a(t.url,t.title),f=t.tabId}else log("window empty tab")}),m(timeLineLength-timeLeft)}function a(e,t){b();var r=i(e),n=new Date-startTime;n<I&&(wastingTime=0),o("add",[n,wastingTime,url,title,startTime]),wastingTime&&s(-n),startTime=new Date,wastingTime=r,url=e,title=t,C()}function i(e){for(var t=0;t<T.length;t++)for(var r=0;r<T[t].length;r++)if(new RegExp("^"+T[t][r].replace(/\./g,"\\.").replace(/\*/g,".*")+"$").test(e))return t+1;return 0}function o(e,t){"add"===e?timeLine.unshift(t):"remove"===e?timeLine.splice(t[0],t[1]):"change"===e?t<timeLine.length||t<0?(c("change",[t,timeLine[t][1]]),timeLine[t][1]&&(timeLine[t][1]=0,s(timeLine[t][0]))):log("change to timeline out of bounds"+t+"/"+timeLine.length):log("timeLine action incorrect")}function s(e){timeLeft+=e}function m(e){u=setTimer(function(){for(var e=new Date-timeLineLength,t=0,r=0,n=0,a=new Date-startTime,i=wastingTime?a:0,s=timeLine.length-1;s!=-1;s--){var l=s?timeLine[s-1][4]:+timeLine[s][4]+timeLine[s][0];if(!(e>l)){n=timeLine[s][4]-e,t=s+1;break}timeLine[s][1]&&(timeLeft+=timeLine[s][0]),r++}r&&o("remove",[t,r]);for(var c=[],u=!1,s=timeLine.length-1;s!=-1;s--){if(timeLine[s][1]){if(!(timeLeft-i>n)){u=!0;break}c.push([s,timeLine[s][1],timeLine[s][0]]),o("change",s)}n+=timeLine[s][0]}u||(n+=a),C(),m(n-timeLeft+i)},e)}function l(){clearTimeout(g),h=f}function c(e,t){chrome.runtime.sendMessage({from:"background",action:e,input:t})}var u,f=-2,d=-3,h=-1,g=-1,p=0,w=[],v=1/0,T=[["*://reddit.com/*","*://*.reddit.com/*","http://threesjs.com/"],["*://*.youtube.com/*","*://imgur.com/*","*://*.imgur.com/*"]];timeLineLength=18e5;var L=3e5,A=2e4,I=2e3;timeLeft=L;var y,b;n(),setupClass=function(){for(var n=new Date,a=r(n),i=0;i<today.length;i++)a<today[i][0][2]&&w.push([today[i][0][1],today[i][0][2]]);w.length&&(v=t(w[0][0]),e(v-n-L))},chrome.tabs.onActivated.addListener(function(e){f=e.tabId,chrome.tabs.get(e.tabId,function(e){a(e.url,e.title)})}),chrome.tabs.onUpdated.addListener(function(e,t,r){t&&"loading"===t.status&&f==e?a(r.url,r.title):t&&t.title&&f==e&&(title=t.title)}),chrome.windows.onFocusChanged.addListener(function(e){d===chrome.windows.WINDOW_ID_NONE||(d!==e&&chrome.tabs.query({windowId:e,active:!0},function(e){if(e.length){var t=e[0];a(t.url,t.title),f=t.tabId}else log("window empty tab")}),d=e)});var C=function(){function e(){c("timer",timeLeft);var e=timeLeft-(wastingTime?new Date-startTime:0),r=0,n=wastingTime;h!==f||p?e>v-new Date&&(e=v-new Date,n=!0):(e=1/0,n=!1);var i=A-new Date+p;h===f&&e<i&&(n||wastingTime||(r=e),e=i,n=!0),t(e,r,n),a(e,n)}function t(e,t,n){if(clearTimeout(s),clearInterval(o),e<0&&(e=0),r(e),n&&e>t){var a=(e-1)%1e3+1;s=setTimeout(function(){e-=a,n&&e>=t&&(r(e),o=setInterval(function(){e-=1e3,n&&e>=t?r(e):clearInterval(o)},1e3))},a)}}function r(e){chrome.browserAction.setBadgeText({text:n(e)})}function n(e){if(e===1/0)return"\u221e";var t=Math.ceil(e/1e3);return Math.floor(t/60)+":"+("0"+Math.floor(t%60)).slice(-2)}function a(e,t){clearTimeout(i),b(),t&&1===wastingTime&&(e<I&&(e=I),i=setTimeout(function(){y(f)},e))}var i=-1,o=-1,s=-1;return e}();!function(){function e(e){chrome.storage.sync.get("redirects",function(r){var n=r.redirects;n||(n=[]);var a=[+new Date,e],i=7e3;JSON.stringify(a).length>i?(log("can't store the following, too large:"),log(a)):JSON.stringify(n).length+JSON.stringify(a).length>i?t(n,e):(n.push(a),chrome.storage.sync.set({redirects:n}))})}function t(t,r){chrome.storage.sync.get("redirectIndexes",function(n){var a=n.redirectIndexes;a||(a=[]);var i="redirect_"+a.length;a.push(i);var o={redirectIndexes:a,redirects:[]};o[i]=t,chrome.storage.sync.set(o),e(r)})}var r=-2;y=function(t){if(t===f){var n=url;chrome.tabs.executeScript(f,{file:"/lib/jquery.min.js"},function(){chrome.tabs.executeScript(f,{file:"/js/content.js"},function(){r=t,e(n)})})}else log("uncaught change in tabId")},b=function(){r!==-2&&(chrome.tabs.sendMessage(r,{action:"unblock"}),r=-2)}}(),resetTime=function(){clearTimer(u),startTime=new Date,timeLeft=L,timeLine=[],n(),c("reset")},VIP=function(){l(),p=0,C()},tempVIP=function(){l(),p=+new Date,g=setTimeout(function(){h=-1,p=0},A),C()},change=function(e){e===-1?(wastingTime=0,a(url,title),c("newPage")):o("change",e),clearTimer(u),m(),C()}}();var scheduleInfo,date=new Date,today;setScheduleInfo();var todaySchedule=function(){function e(e){for(var a=[],i=0;i<scheduleInfo.length;i++)for(var o=0;o<scheduleInfo[i][1].length;o++)for(var s=0;s<scheduleInfo[i][1][o][1].length;s++){var m=scheduleInfo[i][1][o][1][s];t(e,m[0][0])&&r(e,m[2])&&a.push([m[0],m[1],scheduleInfo[i][0],scheduleInfo[i][1][o][0]])}return a.sort(n),a}function t(e,t){var r=new Date(e).getDay(),n=-1;switch(r){case 1:n="M";break;case 2:n="T";break;case 3:n="W";break;case 4:n="Th";break;case 5:n="F"}return t.indexOf(n)>-1&&("T"!=n||"h"!=t[t.indexOf(n)+1])}function r(e,t){return e>=t[0]&&e<=t[1]}function n(e,t){return e[0][1]<t[0][1]?-1:e[0][1]>t[0][1]?1:0}return e}();chrome.commands.onCommand.addListener(function(e){switch(e){case"open_schedule":window.open(chrome.extension.getURL("/html/schedule.html"));break;case"open_options":window.open(chrome.extension.getURL("/html/options.html"))}}),chrome.runtime.onMessage.addListener(function(e,t,r){if("browserAction"===e.from)switch(e.action){case"VIP":VIP();break;case"resetTime":resetTime();break;case"change":change(e.input);break;case"temp":tempVIP();break;case"stopAllAlarms":stopAllAlarms();break;case"snooze":snooze();break;case"setAlarm":setAlarm(e.input,0);break;case"removeAlarm":removeAlarm(e.input);break;case"removeLog":removeLog(e.input)}else if("options"===e.from)switch(e.action){case"resetSchedule":setScheduleInfo()}});